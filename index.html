<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>убер мега календарь для италии с картой</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "custom-bg": "#0f172a",
              "custom-panel": "#111827",
              "custom-panel2": "#0b1220",
              "custom-text": "#e5e7eb",
              "custom-muted": "#9ca3af",
              "custom-accent": "#38bdf8",
              "custom-ok": "#22c55e",
              "custom-warn": "#f59e0b",
              hotel: "#10b981",
              transport: "#3b82f6",
              sightseeing: "#f59e0b",
              other: "#8b5cf6",
            },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --panel2: #0b1220;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #38bdf8;
        --ok: #22c55e;
        --warn: #f59e0b;
        --hotel: #10b981;
        --transport: #3b82f6;
        --sightseeing: #f59e0b;
        --other: #8b5cf6;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial;
      }
      .app {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 8px;
        height: 100vh;
      }
      .calendar-panel {
        background: linear-gradient(180deg, var(--panel), var(--panel2));
        padding: 16px 16px 16px 16px; /* Добавлен отступ сверху под плавающий заголовок */
        overflow-y: auto;
        border-right: 1px solid #1f2937;
        position: relative;
      }
      .map-panel {
        height: 100vh;
        border: 1px solid #1f2937;
        border-radius: 12px;
        overflow: hidden;
        margin: 8px;
      }
      .calendar-header {
        position: absolute;
        top: 16px;
        left: 16px;
        right: 16px;
        z-index: 100;
        background: rgba(17, 24, 39, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        margin-bottom: 0;
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: 60px repeat(7, 1fr);
        gap: 1px;
        margin-bottom: 16px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        overflow: hidden;
      }
      .time-column {
        background: rgba(255, 255, 255, 0.03);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
      }
      .time-slot {
        height: 30px;
        padding: 2px;
        font-size: 9px;
        color: var(--muted);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: flex-start;
        justify-content: center;
      }
      .time-slot.hour-marker {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-weight: 600;
      }
      .calendar-day-header {
        background: rgba(255, 255, 255, 0.05);
        /* padding: 12px 4px; */
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        color: var(--muted);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .calendar-day-column {
        display: flex;
        flex-direction: column;
        position: relative;
      }
      .calendar-day-slot {
        height: 30px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        position: relative;
        background: rgba(255, 255, 255, 0.02);
      }
      .calendar-day-slot:hover {
        background: rgba(255, 255, 255, 0.04);
      }
      .calendar-day-slot.today {
        background: rgba(56, 189, 248, 0.05);
      }
      .activity-block {
        position: absolute;
        left: 2px;
        right: 2px;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
        line-height: 1.2;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 2;
        color: white;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .activity-block:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        z-index: 3;
      }
      .activity-item {
        margin-bottom: 2px;
        padding: 2px 4px;
        border-radius: 4px;
        font-size: 10px;
        line-height: 1.2;
        cursor: pointer;
        transition: all 0.2s;
      }
      .activity-item:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      .activity-hotel {
        background: var(--hotel);
        color: white;
      }
      .activity-transport {
        background: var(--transport);
        color: white;
      }
      .activity-sightseeing {
        background: var(--sightseeing);
        color: white;
      }
      .activity-other {
        background: var(--other);
        color: white;
      }
      .activity-legend {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 16px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 8px;
        font-size: 12px;
      }
      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
      }
      .btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text);
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }
      .btn:hover {
        border-color: var(--accent);
        background: rgba(56, 189, 248, 0.1);
      }
      .btn-primary {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
      }
      .btn-primary:hover {
        background: rgba(56, 189, 248, 0.8);
      }
      .btn-danger {
        background: #dc2626;
        border-color: #dc2626;
        color: white;
      }

      /* Плавающий блок с кнопками */
      .floating-controls {
        position: absolute;
        top: 16px;
        right: 16px;
        z-index: 1000;
        background: rgba(17, 24, 39, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 8px;
        display: flex;
        gap: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .floating-controls .btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: auto;
        white-space: nowrap;
      }

      .floating-controls .btn i {
        margin-right: 4px;
      }
      .btn-danger:hover {
        background: rgba(220, 38, 38, 0.8);
      }

      .form-group {
        margin-bottom: 16px;
      }
      .form-label {
        display: block;
        margin-bottom: 4px;
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
      }
      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: var(--text);
        font-size: 14px;
      }
      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
      }
      .form-textarea {
        min-height: 80px;
        resize: vertical;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      a {
        color: #93c5fd;
      }
      @media (max-width: 1000px) {
        .app {
          grid-template-columns: 1fr;
          grid-template-rows: 1fr 350px;
        }
        .map-panel {
          height: 350px;
          margin: 4px;
        }
        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="bg-custom-bg text-custom-text font-sans">
    <div class="app">
      <!-- Календарная панель -->
      <div class="calendar-panel">
        <div class="text-lg font-bold flex items-center gap-2 mb-1">
          <i class="fas fa-calendar-alt text-custom-accent"></i>
          Планировщик поездки: Италия → Швейцария
        </div>
        <div class="activity-legend">
          <div class="legend-item">
            <div class="legend-color" style="background: var(--hotel)"></div>
            <span>Отель</span>
          </div>
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: var(--transport)"
            ></div>
            <span>Дорога</span>
          </div>
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: var(--sightseeing)"
            ></div>
            <span>Достопримечательности</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--other)"></div>
            <span>Другое</span>
          </div>
        </div>

        <!-- Навигация по неделям -->
        <div class="flex items-center justify-between mb-4">
          <button id="prevWeek" class="btn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="text-lg font-semibold" id="currentWeek">
            5-11 марта 2026
          </div>
          <button id="nextWeek" class="btn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <!-- Календарная сетка -->
        <div class="calendar-grid" id="calendarGrid">
          <!-- Временная колонка и заголовки дней недели будут генерироваться JS -->
        </div>

        <!-- Информация/редактирование выбранной активности -->
        <div id="activityDetails" class="calendar-header" style="display: none">
          <div
            class="text-lg font-semibold mb-3 flex items-center justify-between"
          >
            <div class="flex items-center gap-2">
              <i class="fas fa-info-circle text-custom-accent"></i>
              <span id="detailsTitle">Детали активности</span>
            </div>
            <div class="flex gap-2">
              <button
                id="editActivityBtn"
                class="btn btn-primary"
                style="display: block"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                id="saveActivityBtn"
                class="btn btn-primary"
                style="display: none"
              >
                <i class="fas fa-save"></i>
              </button>
              <button id="cancelEditBtn" class="btn" style="display: none">
                <i class="fas fa-times"></i>
              </button>
              <button
                id="deleteActivityBtn"
                class="btn btn-danger"
                style="display: none"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div id="activityContent"></div>
        </div>
      </div>

      <!-- Плавающий блок с кнопками управления -->
      <div class="floating-controls">
        <button id="addActivityBtn" class="btn btn-primary">
          <i class="fas fa-plus"></i>
          <span class="hidden sm:inline ml-1">Добавить</span>
        </button>
        <button id="exportBtn" class="btn">
          <i class="fas fa-download"></i>
          <span class="hidden sm:inline ml-1">Экспорт</span>
        </button>
        <button id="importBtn" class="btn">
          <i class="fas fa-upload"></i>
          <span class="hidden sm:inline ml-1">Импорт</span>
        </button>
        <button id="fitMapBtn" class="btn">
          <i class="fas fa-expand-arrows-alt"></i>
          <span class="hidden sm:inline ml-1">Карта</span>
        </button>
        <input
          type="file"
          id="importFileInput"
          accept=".json"
          style="display: none"
        />
      </div>

      <!-- Панель карты -->
      <div class="map-panel">
        <div id="map" style="width: 100%; height: 100%"></div>
      </div>
    </div>

    <!-- ====== ДАННЫЕ ====== -->
    <script type="application/json" id="activities-data">
      {
        "currency": "RUB",
        "activities": [
          {
            "id": "neapol",
            "title": "Отель в Неаполе",
            "type": "hotel",
            "startDate": "2026-02-20",
            "startTime": "16:00",
            "endDate": "2026-02-22",
            "endTime": "10:00",
            "location": {
              "name": "Новое место",
              "address": "",
              "lat": 40.8517746,
              "lng": 14.2681244
            },
            "url": "https://ru.trip.com/hotels/detail/?hotelId=3079825&checkIn=2026-02-20&checkOut=2026-02-22&adult=6&children=0&subStamp=3001547&crn=2&travelpurpose=0&curr=RUB&hoteluniquekey=&subChannel=&masterhotelid_tracelogid=&NewTaxDescForAmountshowtype0=F&detailFilters=17%7C1~17~1*80%7C2%7C1~80~2&hotelType=normal&display=incavg&barcurr=RUB&locale=ru-RU",
            "cost": 28744.2,
            "note": ""
          },
          {
            "id": "activity_171231321312",
            "title": "Отель рима",
            "type": "hotel",
            "startDate": "2026-02-22",
            "startTime": "19:00",
            "endDate": "2026-02-24",
            "endTime": "7:00",
            "location": {
              "name": "Отель",
              "address": "",
              "lat": 40.8517746,
              "lng": 14.2681244
            },
            "url": "https://ru.trip.com/hotels/detail/?hotelId=3079825&checkIn=2026-02-20&checkOut=2026-02-22&adult=6&children=0&subStamp=3001547&crn=2&travelpurpose=0&curr=RUB&hoteluniquekey=&subChannel=&masterhotelid_tracelogid=&NewTaxDescForAmountshowtype0=F&detailFilters=17%7C1~17~1*80%7C2%7C1~80~2&hotelType=normal&display=incavg&barcurr=RUB&locale=ru-RU",
            "cost": 28744.2,
            "note": ""
          }
        ]
      }
    </script>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      crossorigin=""
    ></script>
    <script>
      // ===== Утилиты =====
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => document.querySelectorAll(sel);

      const fmtMoney = (n, c = "RUB") =>
        new Intl.NumberFormat("ru-RU", {
          style: "currency",
          currency: c,
        }).format(n);

      const fmtTime = (time) => (time ? time.substring(0, 5) : "");
      const fmtDate = (date) => {
        if (!date) return "";
        const d = new Date(date);
        return d.toLocaleDateString("ru-RU", {
          day: "numeric",
          month: "short",
        });
      };

      const debounce = (fn, ms = 800) => {
        let t;
        return (...a) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...a), ms);
        };
      };

      // ===== LocalStorage управление =====
      const STORAGE_KEY = "italy-trip-activities";

      function saveToStorage(data) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
          console.error("Error saving to localStorage:", e);
          showNotification("Ошибка сохранения данных", "error");
        }
      }

      function loadFromStorage() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            return JSON.parse(stored);
          }
        } catch (e) {
          console.error("Error loading from localStorage:", e);
        }
        // Fallback to default data
        return JSON.parse(
          document.getElementById("activities-data").textContent.trim()
        );
      }

      // ===== Глобальные переменные =====
      let map,
        activityMarkers = [],
        routeLines = [];
      let currentWeekStart = new Date(2026, 2, 3); // Monday, March 3, 2026
      let selectedActivity = null;
      let editingActivityId = null;
      let data = loadFromStorage();

      // Переменные для выбора координат на карте
      let isSelectingCoordinates = false;
      let coordinateSelectionMode = null; // 'main', 'start', 'end'
      let temporaryMarker = null;

      // Функция для определения даты первого события
      function getEarliestEventDate(activities = null) {
        const activitiesToCheck = activities || data.activities;
        if (!activitiesToCheck || activitiesToCheck.length === 0) {
          return new Date(2026, 1, 19); // Февраль 19, 2026 (дата первого события по умолчанию)
        }

        const dates = activitiesToCheck
          .map((activity) => new Date(activity.startDate))
          .filter((date) => !isNaN(date.getTime()))
          .sort((a, b) => a - b);

        return dates.length > 0 ? dates[0] : new Date(2026, 1, 19);
      }

      // Функция для установки календаря на начало недели, содержащей указанную дату
      function setCalendarToDate(targetDate) {
        const monday = new Date(targetDate);
        const dayOfWeek = monday.getDay();
        const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Воскресенье = 0, нужно получить понедельник
        monday.setDate(monday.getDate() - daysToSubtract);
        return monday;
      }

      // Загрузить сохраненную неделю календаря или установить на первое событие
      const savedWeekStart = localStorage.getItem("currentWeekStart");
      if (savedWeekStart) {
        currentWeekStart = new Date(savedWeekStart);
      } else {
        // Если нет сохраненной даты, открыть календарь на неделе с первым событием
        const earliestEventDate = getEarliestEventDate();
        currentWeekStart = setCalendarToDate(earliestEventDate);
      }

      // ===== Иконки для разных типов активностей =====
      const activityIcons = {
        hotel: { icon: "fas fa-bed", color: "var(--hotel)" },
        transport: { icon: "fas fa-route", color: "var(--transport)" },
        sightseeing: { icon: "fas fa-camera", color: "var(--sightseeing)" },
        other: { icon: "fas fa-star", color: "var(--other)" },
      };

      // ===== Функции работы с картой =====
      function clearMap() {
        activityMarkers.forEach((m) => map.removeLayer(m));
        activityMarkers = [];
        routeLines.forEach((r) => map.removeLayer(r));
        routeLines = [];
      }

      function fitToActivities() {
        if (activityMarkers.length === 0) return;
        const group = L.featureGroup(activityMarkers);
        map.fitBounds(group.getBounds(), { padding: [20, 20] });
      }

      function createActivityMarker(activity) {
        const iconInfo = activityIcons[activity.type] || activityIcons.other;
        let lat, lng;

        if (activity.location.lat && activity.location.lng) {
          lat = activity.location.lat;
          lng = activity.location.lng;
        } else if (activity.location.startLat && activity.location.startLng) {
          lat = activity.location.startLat;
          lng = activity.location.startLng;
        } else {
          return null;
        }

        const marker = L.marker([lat, lng], {
          icon: L.divIcon({
            className: "activity-marker",
            html: `<div style="background: ${iconInfo.color}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"><i class="${iconInfo.icon}" style="font-size: 12px;"></i></div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15],
          }),
        }).addTo(map);

        marker.bindPopup(createActivityPopup(activity));
        marker.on("click", () => selectActivity(activity));

        return marker;
      }

      function createActivityPopup(activity) {
        return `
          <div class="p-3 min-w-[280px]">
            <div class="flex items-center gap-2 mb-3">
              <div style="background: ${
                activityIcons[activity.type].color
              }; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                <i class="${
                  activityIcons[activity.type].icon
                }" style="font-size: 14px;"></i>
              </div>
              <div>
                <div class="font-bold text-base">${activity.title}</div>
                <div class="text-sm text-gray-600">${
                  activity.location.name
                }</div>
              </div>
            </div>
            
            <div class="space-y-2 mb-3">
              <div class="flex items-center gap-2">
                <i class="fas fa-calendar text-blue-600"></i>
                <span class="text-sm">
                  ${fmtDate(activity.startDate)}${
          activity.startDate !== activity.endDate
            ? " - " + fmtDate(activity.endDate)
            : ""
        }
                  ${
                    activity.startTime ? ", " + fmtTime(activity.startTime) : ""
                  }${
          activity.endTime && activity.startTime !== activity.endTime
            ? " - " + fmtTime(activity.endTime)
            : ""
        }
                </span>
              </div>
              
              ${
                activity.cost
                  ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-ruble-sign text-yellow-600"></i>
                  <span class="text-sm">${fmtMoney(activity.cost)}</span>
                </div>
              `
                  : ""
              }
              
              ${
                activity.location.address
                  ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-map-marker-alt text-red-600"></i>
                  <span class="text-sm">${activity.location.address}</span>
                </div>
              `
                  : ""
              }
            </div>
            
            ${
              activity.note
                ? `
              <div class="mb-3 p-2 bg-blue-50 rounded text-sm text-blue-800">
                <i class="fas fa-info-circle mr-1"></i>${activity.note}
              </div>
            `
                : ""
            }
            
            ${
              activity.url
                ? `
              <div class="mt-3">
                <a href='${activity.url}' target='_blank' rel='noopener' class="inline-flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                  <i class="fas fa-external-link-alt"></i>Открыть ссылку
                </a>
              </div>
            `
                : ""
            }
          </div>
        `;
      }

      function selectActivity(activity) {
        // Сбросить выделение предыдущего маршрута если был
        if (
          selectedActivity &&
          selectedActivity.type === "transport" &&
          selectedActivity.location.startLat &&
          selectedActivity.location.endLat
        ) {
          unhighlightRoute(selectedActivity);
        }

        selectedActivity = activity;
        showActivityDetails(activity);

        // Выделить маршрут для транспорта
        if (
          activity.type === "transport" &&
          activity.location.startLat &&
          activity.location.endLat
        ) {
          highlightRoute(activity);
        }
      }

      async function buildRouteForActivity(
        transportActivity,
        highlight = false
      ) {
        try {
          const startLng = transportActivity.location.startLng;
          const startLat = transportActivity.location.startLat;
          const endLng = transportActivity.location.endLng;
          const endLat = transportActivity.location.endLat;

          const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;

          const res = await fetch(url);
          if (!res.ok) return;

          const json = await res.json();
          if (!json.routes || !json.routes[0]) return;

          const route = json.routes[0];
          const latlngs = route.geometry.coordinates.map(([lng, lat]) => [
            lat,
            lng,
          ]);

          // Определить стили маршрута
          const routeStyles = {
            color: activityIcons.transport.color,
            weight: highlight ? 6 : 3,
            opacity: highlight ? 1.0 : 0.6,
            dashArray: highlight ? null : "5, 5",
          };

          const routeLine = L.polyline(latlngs, routeStyles).addTo(map);

          // Добавить ID активности к маршруту для идентификации
          routeLine.activityId = transportActivity.id;
          routeLine.isHighlighted = highlight;

          routeLines.push(routeLine);

          // Если это выделенный маршрут, показать его на карте
          if (highlight) {
            const bounds = L.latLngBounds([
              [startLat, startLng],
              [endLat, endLng],
            ]);
            map.fitBounds(bounds, { padding: [20, 20] });
          }
        } catch (error) {
          console.error("Route building error:", error);
        }
      }

      // Функция для выделения конкретного маршрута
      async function highlightRoute(transportActivity) {
        // Найти и удалить существующий маршрут для этой активности
        const existingRouteIndex = routeLines.findIndex(
          (route) => route.activityId === transportActivity.id
        );

        if (existingRouteIndex !== -1) {
          map.removeLayer(routeLines[existingRouteIndex]);
          routeLines.splice(existingRouteIndex, 1);
        }

        // Создать выделенный маршрут
        await buildRouteForActivity(transportActivity, true);
      }

      // Функция для сброса выделения маршрута
      async function unhighlightRoute(transportActivity) {
        // Найти и удалить выделенный маршрут
        const highlightedRouteIndex = routeLines.findIndex(
          (route) =>
            route.activityId === transportActivity.id && route.isHighlighted
        );

        if (highlightedRouteIndex !== -1) {
          map.removeLayer(routeLines[highlightedRouteIndex]);
          routeLines.splice(highlightedRouteIndex, 1);
        }

        // Создать обычный маршрут
        await buildRouteForActivity(transportActivity, false);
      }

      let isEditingActivity = false;
      let originalActivityData = null;

      function showActivityDetails(activity) {
        const detailsEl = $("#activityDetails");
        const contentEl = $("#activityContent");

        selectedActivity = activity;
        isEditingActivity = false;

        // Обновить кнопки
        $("#editActivityBtn").style.display = "block";
        $("#saveActivityBtn").style.display = "none";
        $("#cancelEditBtn").style.display = "none";
        $("#deleteActivityBtn").style.display = "none";
        $("#detailsTitle").textContent = "Детали активности";

        renderActivityContent(activity, false);
        detailsEl.style.display = "block";
      }

      function renderActivityContent(activity, isEditing = false) {
        const contentEl = $("#activityContent");

        if (isEditing) {
          contentEl.innerHTML = `
            <div class="space-y-4">
              <div class="form-group">
                <label class="form-label">Название</label>
                <input type="text" id="editTitle" class="form-input" value="${
                  activity.title || ""
                }" required>
              </div>
              
              <div class="form-group">
                <label class="form-label">Тип активности</label>
                <select id="editType" class="form-select" required>
                  <option value="hotel" ${
                    activity.type === "hotel" ? "selected" : ""
                  }>🏨 Отель</option>
                  <option value="transport" ${
                    activity.type === "transport" ? "selected" : ""
                  }>🚗 Дорога</option>
                  <option value="sightseeing" ${
                    activity.type === "sightseeing" ? "selected" : ""
                  }>📸 Достопримечательности</option>
                  <option value="other" ${
                    activity.type === "other" ? "selected" : ""
                  }>⭐ Другое</option>
                </select>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Дата начала</label>
                  <input type="date" id="editStartDate" class="form-input" value="${
                    activity.startDate || ""
                  }" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Время начала</label>
                  <input type="time" id="editStartTime" class="form-input" value="${
                    activity.startTime || ""
                  }">
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Дата окончания</label>
                  <input type="date" id="editEndDate" class="form-input" value="${
                    activity.endDate || ""
                  }" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Время окончания</label>
                  <input type="time" id="editEndTime" class="form-input" value="${
                    activity.endTime || ""
                  }">
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">Место</label>
                <input type="text" id="editLocationName" class="form-input" value="${
                  activity.location?.name || ""
                }" placeholder="Название места" required>
              </div>
              
              <div class="form-group">
                <label class="form-label">Адрес</label>
                <input type="text" id="editLocationAddress" class="form-input" value="${
                  activity.location?.address || ""
                }" placeholder="Полный адрес">
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Широта</label>
                  <input type="number" step="0.000001" id="editLat" class="form-input" value="${
                    activity.location?.lat || ""
                  }" placeholder="41.9028">
                </div>
                <div class="form-group">
                  <label class="form-label">Долгота</label>
                  <input type="number" step="0.000001" id="editLng" class="form-input" value="${
                    activity.location?.lng || ""
                  }" placeholder="12.4964">
                </div>
              </div>
              
              <div class="form-group">
                <button type="button" id="selectCoordinatesBtn" class="btn btn-primary" style="width: 100%;">
                  <i class="fas fa-map-marker-alt mr-1"></i>Выбрать на карте
                </button>
              </div>
              
              <div id="editTransportFields" style="display: ${
                activity.type === "transport" ? "block" : "none"
              };">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Начальная широта</label>
                    <input type="number" step="0.000001" id="editStartLat" class="form-input" value="${
                      activity.location?.startLat || ""
                    }">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Начальная долгота</label>
                    <input type="number" step="0.000001" id="editStartLng" class="form-input" value="${
                      activity.location?.startLng || ""
                    }">
                  </div>
                </div>
                <div class="form-group">
                  <button type="button" id="selectStartCoordinatesBtn" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-map-marker-alt mr-1"></i>Выбрать начальную точку на карте
                  </button>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Конечная широта</label>
                    <input type="number" step="0.000001" id="editEndLat" class="form-input" value="${
                      activity.location?.endLat || ""
                    }">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Конечная долгота</label>
                    <input type="number" step="0.000001" id="editEndLng" class="form-input" value="${
                      activity.location?.endLng || ""
                    }">
                  </div>
                </div>
                <div class="form-group">
                  <button type="button" id="selectEndCoordinatesBtn" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-map-marker-alt mr-1"></i>Выбрать конечную точку на карте
                  </button>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">URL (ссылка)</label>
                <input type="url" id="editUrl" class="form-input" value="${
                  activity.url || ""
                }" placeholder="https://example.com">
              </div>
              
              <div class="form-group">
                <label class="form-label">Стоимость (руб.)</label>
                <input type="number" id="editCost" class="form-input" value="${
                  activity.cost || ""
                }" placeholder="0">
              </div>
              
              <div class="form-group">
                <label class="form-label">Примечания</label>
                <textarea id="editNote" class="form-textarea" placeholder="Дополнительная информация...">${
                  activity.note || ""
                }</textarea>
              </div>
            </div>
          `;

          // Обработчик изменения типа для показа/скрытия полей транспорта
          $("#editType").addEventListener("change", () => {
            const transportFields = $("#editTransportFields");
            transportFields.style.display =
              $("#editType").value === "transport" ? "block" : "none";
          });
        } else {
          contentEl.innerHTML = `
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <div style="background: ${
                  activityIcons[activity.type]?.color || "var(--other)"
                }; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="${
                    activityIcons[activity.type]?.icon || "fas fa-star"
                  }"></i>
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-white">${
                    activity.title
                  }</h3>
                  <p class="text-sm text-custom-muted">${
                    activity.location?.name || ""
                  }</p>
                  </div>
                </div>
              
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div>
                  <span class="text-custom-muted">Начало:</span><br>
                  <span class="text-white">${fmtDate(activity.startDate)}</span>
                  ${
                    activity.startTime
                      ? `<br><span class="text-custom-accent">${fmtTime(
                          activity.startTime
                        )}</span>`
                      : ""
                  }
              </div>
                <div>
                  <span class="text-custom-muted">Конец:</span><br>
                  <span class="text-white">${fmtDate(activity.endDate)}</span>
                  ${
                    activity.endTime
                      ? `<br><span class="text-custom-accent">${fmtTime(
                          activity.endTime
                        )}</span>`
                      : ""
                  }
                </div>
              </div>
              
              ${
                activity.location?.address
                  ? `
                <div class="text-sm">
                  <span class="text-custom-muted">Адрес:</span><br>
                  <span class="text-white">${activity.location.address}</span>
                </div>
              `
                  : ""
              }
              
              ${
                activity.cost
                  ? `
                <div class="text-sm">
                  <span class="text-custom-muted">Стоимость:</span>
                  <span class="text-custom-accent font-semibold ml-2">${fmtMoney(
                    activity.cost
                  )}</span>
                </div>
              `
                  : ""
              }
              
              ${
                activity.note
                  ? `
                <div class="text-sm p-3 bg-white/5 border border-white/10 rounded">
                  <i class="fas fa-sticky-note text-custom-accent mr-2"></i>
                  <strong>Примечания:</strong><br>
                  <span class="text-custom-text">${activity.note}</span>
                </div>
              `
                  : ""
              }
              
              ${
                activity.url
                  ? `
                <div class="pt-2">
                  <a href='${activity.url}' target='_blank' rel='noopener' class="btn btn-primary">
                    <i class="fas fa-external-link-alt mr-1"></i>Открыть ссылку
                  </a>
                </div>
              `
                  : ""
              }
              </div>
            `;
        }
      }

      // ===== Функции работы с календарем =====
      function renderCalendar() {
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);

        // Обновить заголовок недели
        const monthNames = [
          "янв",
          "фев",
          "мар",
          "апр",
          "май",
          "июн",
          "июл",
          "авг",
          "сен",
          "окт",
          "ноя",
          "дек",
        ];
        const startStr = `${currentWeekStart.getDate()} ${
          monthNames[currentWeekStart.getMonth()]
        }`;
        const endStr = `${weekEnd.getDate()} ${
          monthNames[weekEnd.getMonth()]
        } ${weekEnd.getFullYear()}`;
        $("#currentWeek").textContent = `${startStr} - ${endStr}`;

        const grid = $("#calendarGrid");
        grid.innerHTML = "";

        // Временные слоты (с 0:00 до 23:00)
        const timeSlots = [];
        for (let hour = 0; hour < 24; hour++) {
          timeSlots.push(`${String(hour).padStart(2, "0")}:00`);
        }

        // Создать временную колонку
        const timeColumn = document.createElement("div");
        timeColumn.className = "time-column";

        // Пустая ячейка для заголовка
        const emptyHeader = document.createElement("div");
        emptyHeader.className = "calendar-day-header";
        emptyHeader.style.height = "50px";
        timeColumn.appendChild(emptyHeader);

        // Временные слоты
        timeSlots.forEach((time) => {
          const timeSlot = document.createElement("div");
          timeSlot.className = "time-slot hour-marker";
          timeSlot.textContent = time;
          timeColumn.appendChild(timeSlot);
        });

        grid.appendChild(timeColumn);

        // Создать колонки для дней недели
        const dayNames = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"];
        for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
          const currentDay = new Date(currentWeekStart);
          currentDay.setDate(currentDay.getDate() + dayOffset);

          const dayColumn = document.createElement("div");
          dayColumn.className = "calendar-day-column";

          // Заголовок дня
          const dayHeader = document.createElement("div");
          dayHeader.className = "calendar-day-header";
          dayHeader.innerHTML = `
            <div>${dayNames[dayOffset]}</div>
            <div style="font-size: 16px; font-weight: bold; margin-top: 2px;">${currentDay.getDate()}</div>
          `;
          dayColumn.appendChild(dayHeader);

          const today = new Date();
          const isToday = currentDay.toDateString() === today.toDateString();

          // Временные слоты для этого дня
          timeSlots.forEach((time) => {
            const daySlot = document.createElement("div");
            daySlot.className = "calendar-day-slot";
            if (isToday) daySlot.classList.add("today");

            // Добавить обработчик для создания новой активности
            daySlot.addEventListener("dblclick", () => {
              const dateStr = currentDay.toISOString().split("T")[0];
              createNewActivity(dateStr, time);
            });

            dayColumn.appendChild(daySlot);
          });

          grid.appendChild(dayColumn);
        }

        // Отобразить активности
        renderActivitiesOnCalendar();
      }

      function renderActivitiesOnCalendar() {
        // Очистить существующие блоки активностей
        $$(".activity-block").forEach((block) => block.remove());

        // Группировать активности по дням для расчета наложений
        const activitiesByDay = {};

        data.activities.forEach((activity) => {
          const activityStart = new Date(
            activity.startDate + "T" + (activity.startTime || "00:00")
          );
          const activityEnd = new Date(
            activity.endDate + "T" + (activity.endTime || "23:59")
          );

          // Проверить, попадает ли активность в текущую неделю
          const weekStart = new Date(currentWeekStart);
          const weekEnd = new Date(currentWeekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          weekEnd.setHours(23, 59, 59);

          if (activityEnd < weekStart || activityStart > weekEnd) return;

          // Рассчитать позицию на календаре
          const startDay = Math.max(
            0,
            Math.floor((activityStart - weekStart) / (1000 * 60 * 60 * 24))
          );
          const endDay = Math.min(
            6,
            Math.floor((activityEnd - weekStart) / (1000 * 60 * 60 * 24))
          );

          for (let dayOffset = startDay; dayOffset <= endDay; dayOffset++) {
            if (!activitiesByDay[dayOffset]) {
              activitiesByDay[dayOffset] = [];
            }

            // Рассчитать временные позиции
            const dayStart = new Date(weekStart);
            dayStart.setDate(dayStart.getDate() + dayOffset);
            dayStart.setHours(0, 0, 0); // Начало календаря в 0:00

            // Рассчитать время относительно текущего дня
            let relativeStart = (activityStart - dayStart) / (1000 * 60 * 60);
            let relativeEnd = (activityEnd - dayStart) / (1000 * 60 * 60);

            // Для многодневных мероприятий корректно обрабатываем границы дня
            if (relativeStart < 0) relativeStart = 0; // Мероприятие началось раньше этого дня
            if (relativeEnd > 24) relativeEnd = 24; // Мероприятие продолжается после этого дня
            if (relativeStart >= 24) relativeStart = 24; // Начинается после этого дня
            if (relativeEnd <= 0) relativeEnd = 0; // Заканчивается до этого дня

            if (relativeEnd <= 0 || relativeStart >= 24) continue;

            activitiesByDay[dayOffset].push({
              activity,
              start: relativeStart,
              end: relativeEnd,
              dayOffset,
            });
          }
        });

        // Отрисовать активности с учетом наложений
        Object.keys(activitiesByDay).forEach((dayOffset) => {
          const dayActivities = activitiesByDay[dayOffset];
          const grid = $("#calendarGrid");
          const dayColumn = grid.children[parseInt(dayOffset) + 1]; // +1 для временной колонки
          if (!dayColumn) return;

          // Сортировать активности по времени начала
          dayActivities.sort((a, b) => a.start - b.start);

          // Рассчитать уровни наложения
          const levels = [];
          dayActivities.forEach((activityData) => {
            let level = 0;

            // Найти свободный уровень
            while (
              levels[level] &&
              levels[level].some(
                (existing) =>
                  !(
                    activityData.end <= existing.start ||
                    activityData.start >= existing.end
                  )
              )
            ) {
              level++;
            }

            if (!levels[level]) levels[level] = [];
            levels[level].push(activityData);
            activityData.level = level;
          });

          // Отрисовать активности
          dayActivities.forEach((activityData) => {
            const { activity, start, end, level } = activityData;
            const maxLevels = levels.length;

            const blockTop = Math.max(0, start) * 30 + 50; // 30px на час + 50px заголовок
            const blockHeight = Math.max(
              15,
              (Math.min(24, end) - Math.max(0, start)) * 30
            );

            // Рассчитать ширину и отступ с учетом наложений
            const baseWidth = 100; // 100% ширины минус отступы
            const baseLeftMargin = 10; // базовый отступ слева в px
            const rightMargin = 10; // отступ справа в px

            let width, leftOffset;
            if (maxLevels === 1) {
              // Нет наложений - полная ширина
              width = `calc(${baseWidth}% - ${baseLeftMargin + rightMargin}px)`;
              leftOffset = `${baseLeftMargin}px`;
            } else {
              // Есть наложения - рассчитать позицию
              const widthPercent = baseWidth / maxLevels;
              const levelOffset = level * widthPercent + baseLeftMargin;
              width = `calc(${widthPercent}% - ${
                baseLeftMargin + rightMargin / maxLevels
              }px)`;
              leftOffset = `calc(${
                level * widthPercent
              }% + ${baseLeftMargin}px)`;
            }

            const activityBlock = document.createElement("div");
            activityBlock.className = `activity-block activity-${activity.type}`;
            activityBlock.style.background =
              activityIcons[activity.type]?.color || "var(--other)";
            activityBlock.style.top = blockTop + "px";
            activityBlock.style.height = blockHeight + "px";
            activityBlock.style.width = width;
            activityBlock.style.left = leftOffset;
            activityBlock.style.zIndex = 10 + level; // Более высокий z-index для верхних уровней
            activityBlock.textContent = activity.title;
            activityBlock.title = `${activity.title}\n${
              activity.location.name
            }\n${fmtTime(activity.startTime)} - ${fmtTime(activity.endTime)}`;

            activityBlock.addEventListener("click", (e) => {
              e.stopPropagation();
              selectActivity(activity);

              // Найти маркер на карте и открыть popup
              const marker = activityMarkers.find(
                (m) => m.activityId === activity.id
              );
              if (marker) {
                marker.openPopup();
                map.setView(marker.getLatLng(), 12);
              }
            });

            // Убираем двойной клик для открытия модального окна
            // activityBlock.addEventListener("dblclick", (e) => {
            //   e.stopPropagation();
            //   openActivityModal(activity);
            // });

            dayColumn.appendChild(activityBlock);
          });
        });
      }

      function renderMap() {
        clearMap();

        // Отобразить маркеры для всех активностей
        data.activities.forEach((activity) => {
          const marker = createActivityMarker(activity);
          if (marker) {
            marker.activityId = activity.id;
            activityMarkers.push(marker);
          }
        });

        // Отобразить маршруты для всех активностей типа "transport"
        const transportActivities = data.activities.filter(
          (activity) => activity.type === "transport"
        );
        transportActivities.forEach((activity) => {
          if (
            activity.location.startLat &&
            activity.location.startLng &&
            activity.location.endLat &&
            activity.location.endLng
          ) {
            buildRouteForActivity(activity);
          }
        });

        if (activityMarkers.length > 0) {
          fitToActivities();
        }
      }

      // ===== Функции редактирования в детальной панели =====
      function startEditingActivity() {
        if (!selectedActivity) return;

        isEditingActivity = true;
        originalActivityData = JSON.parse(JSON.stringify(selectedActivity)); // глубокая копия

        // Обновить кнопки
        $("#editActivityBtn").style.display = "none";
        $("#saveActivityBtn").style.display = "block";
        $("#cancelEditBtn").style.display = "block";
        $("#deleteActivityBtn").style.display = "block";
        $("#detailsTitle").textContent = "Редактирование активности";

        renderActivityContent(selectedActivity, true);

        // Добавить обработчики для кнопок выбора координат
        setTimeout(() => {
          const selectBtn = $("#selectCoordinatesBtn");
          const selectStartBtn = $("#selectStartCoordinatesBtn");
          const selectEndBtn = $("#selectEndCoordinatesBtn");

          if (selectBtn) {
            selectBtn.addEventListener("click", () =>
              startCoordinateSelection("main")
            );
          }
          if (selectStartBtn) {
            selectStartBtn.addEventListener("click", () =>
              startCoordinateSelection("start")
            );
          }
          if (selectEndBtn) {
            selectEndBtn.addEventListener("click", () =>
              startCoordinateSelection("end")
            );
          }
        }, 100);
      }

      function cancelEditingActivity() {
        if (!originalActivityData) return;

        isEditingActivity = false;
        selectedActivity = originalActivityData;

        // Остановить выбор координат если активен
        stopCoordinateSelection();

        // Обновить кнопки
        $("#editActivityBtn").style.display = "block";
        $("#saveActivityBtn").style.display = "none";
        $("#cancelEditBtn").style.display = "none";
        $("#deleteActivityBtn").style.display = "none";
        $("#detailsTitle").textContent = "Детали активности";

        renderActivityContent(selectedActivity, false);
        originalActivityData = null;
      }

      function saveEditedActivity() {
        if (!selectedActivity || !isEditingActivity) return;

        // Собрать данные из формы
        const formData = {
          title: $("#editTitle").value,
          type: $("#editType").value,
          startDate: $("#editStartDate").value,
          startTime: $("#editStartTime").value,
          endDate: $("#editEndDate").value,
          endTime: $("#editEndTime").value,
          location: {
            name: $("#editLocationName").value,
            address: $("#editLocationAddress").value,
            lat: parseFloat($("#editLat").value) || null,
            lng: parseFloat($("#editLng").value) || null,
          },
          url: $("#editUrl").value,
          cost: parseFloat($("#editCost").value) || 0,
          note: $("#editNote").value,
        };

        // Добавить поля для транспорта
        if (formData.type === "transport") {
          formData.location.startLat =
            parseFloat($("#editStartLat").value) || null;
          formData.location.startLng =
            parseFloat($("#editStartLng").value) || null;
          formData.location.endLat = parseFloat($("#editEndLat").value) || null;
          formData.location.endLng = parseFloat($("#editEndLng").value) || null;
        }

        // Обновить активность в данных
        const index = data.activities.findIndex(
          (a) => a.id === selectedActivity.id
        );
        if (index !== -1) {
          data.activities[index] = { ...data.activities[index], ...formData };
          selectedActivity = data.activities[index];
        }

        // Сохранить и обновить интерфейс
        saveToStorage(data);
        renderCalendar();
        renderMap();

        isEditingActivity = false;

        // Обновить кнопки
        $("#editActivityBtn").style.display = "block";
        $("#saveActivityBtn").style.display = "none";
        $("#cancelEditBtn").style.display = "none";
        $("#deleteActivityBtn").style.display = "none";
        $("#detailsTitle").textContent = "Детали активности";

        renderActivityContent(selectedActivity, false);
        originalActivityData = null;

        showNotification("Активность обновлена", "success");
      }

      function deleteCurrentActivity() {
        if (!selectedActivity) return;

        if (confirm("Вы уверены, что хотите удалить эту активность?")) {
          data.activities = data.activities.filter(
            (a) => a.id !== selectedActivity.id
          );
          saveToStorage(data);
          renderCalendar();
          renderMap();

          $("#activityDetails").style.display = "none";
          selectedActivity = null;
          isEditingActivity = false;
          originalActivityData = null;

          showNotification("Активность удалена", "success");
        }
      }

      // ===== Создание новых активностей (упрощенная версия) =====
      function createNewActivity(defaultDate = null, defaultTime = null) {
        const newActivity = {
          id: "activity_" + Date.now(),
          title: "Новая активность",
          type: "other",
          startDate: defaultDate || "2026-02-22",
          startTime: defaultTime || "12:00",
          endDate: defaultDate || "2026-02-22",
          endTime: "13:00",
          location: {
            name: "Новое место",
            address: "",
            lat: null,
            lng: null,
          },
          url: "",
          cost: 0,
          note: "",
        };

        data.activities.push(newActivity);
        saveToStorage(data);
        renderCalendar();
        renderMap();

        // Выбрать и начать редактирование новой активности
        selectedActivity = newActivity;
        showActivityDetails(newActivity);
        startEditingActivity();

        showNotification("Новая активность создана", "success");
      }

      // ===== Функции выбора координат на карте =====
      function startCoordinateSelection(mode = "main") {
        isSelectingCoordinates = true;
        coordinateSelectionMode = mode;
        map.getContainer().style.cursor = "crosshair";

        // Показать подсказку
        const modeText =
          mode === "start"
            ? "начальную точку"
            : mode === "end"
            ? "конечную точку"
            : "местоположение";
        showNotification(`Кликните на карте для выбора "${modeText}"`, "info");
      }

      function stopCoordinateSelection() {
        isSelectingCoordinates = false;
        coordinateSelectionMode = null;
        map.getContainer().style.cursor = "";

        // Удалить временный маркер
        if (temporaryMarker) {
          map.removeLayer(temporaryMarker);
          temporaryMarker = null;
        }
      }

      function handleMapClick(e) {
        if (!isSelectingCoordinates) return;

        const lat = e.latlng.lat.toFixed(7);
        const lng = e.latlng.lng.toFixed(7);

        // Удалить предыдущий временный маркер
        if (temporaryMarker) {
          map.removeLayer(temporaryMarker);
        }

        // Создать временный маркер
        temporaryMarker = L.marker([lat, lng], {
          icon: L.divIcon({
            className: "temp-marker",
            html: '<div style="background: #ff6b6b; border: 2px solid white; border-radius: 50%; width: 16px; height: 16px; margin: -8px;"></div>',
            iconSize: [16, 16],
            iconAnchor: [8, 8],
          }),
        }).addTo(map);

        // Заполнить соответствующие поля формы
        if (coordinateSelectionMode === "start") {
          $("#editStartLat").value = lat;
          $("#editStartLng").value = lng;
          showNotification("Начальная точка выбрана", "success");
        } else if (coordinateSelectionMode === "end") {
          $("#editEndLat").value = lat;
          $("#editEndLng").value = lng;
          showNotification("Конечная точка выбрана", "success");
        } else {
          $("#editLat").value = lat;
          $("#editLng").value = lng;
          showNotification("Местоположение выбрано", "success");
        }

        // Остановить выбор координат
        setTimeout(() => stopCoordinateSelection(), 1000);
      }

      // ===== Функции экспорта и импорта =====
      function exportData() {
        try {
          // Собираем полное состояние приложения
          const exportData = {
            version: "1.0",
            exportDate: new Date().toISOString(),
            appTitle: "Планировщик поездки: Италия → Швейцария",
            currency: data.currency,
            currentWeekStart: currentWeekStart.toISOString(),
            activities: data.activities,
            selectedActivityId: selectedActivity ? selectedActivity.id : null,
          };

          const dataStr = JSON.stringify(exportData, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });

          const link = document.createElement("a");
          link.href = URL.createObjectURL(dataBlob);
          link.download = `trip-plan-${
            new Date().toISOString().split("T")[0]
          }.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          // Освобождаем память
          URL.revokeObjectURL(link.href);

          showNotification("Планировщик поездки экспортирован!", "success");
        } catch (error) {
          console.error("Ошибка экспорта:", error);
          showNotification("Ошибка при экспорте данных", "error");
        }
      }

      function importData() {
        const fileInput = $("#importFileInput");
        fileInput.click();
      }

      function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importedData = JSON.parse(e.target.result);

            // Валидация импортируемых данных
            if (
              !importedData.activities ||
              !Array.isArray(importedData.activities)
            ) {
              throw new Error(
                "Неверный формат файла: отсутствует массив активностей"
              );
            }

            // Проверка версии файла
            if (importedData.version && importedData.version !== "1.0") {
              throw new Error(
                `Неподдерживаемая версия файла: ${importedData.version}`
              );
            }

            // Проверка обязательных полей в активностях
            const requiredFields = [
              "id",
              "title",
              "type",
              "startDate",
              "location",
            ];
            for (const activity of importedData.activities) {
              for (const field of requiredFields) {
                if (!activity[field]) {
                  throw new Error(
                    `Неверный формат активности: отсутствует поле ${field}`
                  );
                }
              }
            }

            // Подтверждение импорта
            const title = importedData.appTitle || "планировщик поездки";
            const confirmMessage = `Импортировать "${title}"?\n\nЭто заменит ВСЕ текущие данные:\n• ${importedData.activities.length} активностей\n• Настройки календаря\n• Всю конфигурацию\n\nПродолжить?`;
            if (!confirm(confirmMessage)) {
              return;
            }

            // Полная замена данных приложения
            data.activities = importedData.activities;
            data.currency = importedData.currency || "RUB";

            // Восстановление состояния календаря
            if (importedData.currentWeekStart) {
              currentWeekStart = new Date(importedData.currentWeekStart);
            } else {
              // Если нет сохраненной недели, установить на первое событие
              const earliestEventDate = getEarliestEventDate(
                importedData.activities
              );
              currentWeekStart = setCalendarToDate(earliestEventDate);
            }

            // Очистка текущего состояния
            selectedActivity = null;
            isEditingActivity = false;
            originalActivityData = null;

            // Сохранение в localStorage
            saveToStorage();

            // Сохранение текущей недели календаря
            localStorage.setItem(
              "currentWeekStart",
              currentWeekStart.toISOString()
            );

            // Полное обновление интерфейса
            clearMap();
            renderCalendar();
            renderActivitiesOnCalendar();
            renderMap();

            // Скрыть панель деталей
            $("#activityDetails").style.display = "none";

            // Восстановление выбранной активности если есть
            if (importedData.selectedActivityId) {
              const activityToSelect = data.activities.find(
                (a) => a.id === importedData.selectedActivityId
              );
              if (activityToSelect) {
                setTimeout(() => selectActivity(activityToSelect), 100);
              }
            }

            showNotification(
              `Планировщик поездки импортирован! Загружено ${importedData.activities.length} активностей`,
              "success"
            );
          } catch (error) {
            console.error("Ошибка импорта:", error);
            showNotification(`Ошибка импорта: ${error.message}`, "error");
          }
        };

        reader.readAsText(file);
        // Очистить input для возможности повторного выбора того же файла
        event.target.value = "";
      }

      // ===== Функция показа уведомлений =====
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        const colors = {
          success: "bg-green-500/90 border-green-400",
          error: "bg-red-500/90 border-red-400",
          warning: "bg-yellow-500/90 border-yellow-400",
          info: "bg-blue-500/90 border-blue-400",
        };
        const icons = {
          success: "fas fa-check-circle",
          error: "fas fa-exclamation-circle",
          warning: "fas fa-exclamation-triangle",
          info: "fas fa-info-circle",
        };

        notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-3 rounded-lg border shadow-lg z-50 flex items-center gap-2 transform translate-x-full transition-transform`;
        notification.innerHTML = `<i class="${icons[type]}"></i>${message}`;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.remove("translate-x-full");
        }, 100);

        setTimeout(() => {
          notification.classList.add("translate-x-full");
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // ===== Инициализация =====
      function init() {
        // Инициализация карты
        map = L.map("map", { zoomControl: true, preferCanvas: true }).setView(
          [43.0, 12.0],
          6
        );
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap",
        }).addTo(map);

        // Добавить обработчик клика для выбора координат
        map.on("click", handleMapClick);

        // Обработчики событий
        $("#prevWeek").addEventListener("click", () => {
          currentWeekStart.setDate(currentWeekStart.getDate() - 1);
          localStorage.setItem(
            "currentWeekStart",
            currentWeekStart.toISOString()
          );
          renderCalendar();
        });

        $("#nextWeek").addEventListener("click", () => {
          currentWeekStart.setDate(currentWeekStart.getDate() + 1);
          localStorage.setItem(
            "currentWeekStart",
            currentWeekStart.toISOString()
          );
          renderCalendar();
        });

        $("#fitMapBtn").addEventListener("click", fitToActivities);
        $("#exportBtn").addEventListener("click", exportData);
        $("#importBtn").addEventListener("click", importData);
        $("#importFileInput").addEventListener("change", handleFileImport);

        // Кнопки редактирования в детальной панели
        $("#addActivityBtn").addEventListener("click", () =>
          createNewActivity()
        );
        $("#editActivityBtn").addEventListener("click", startEditingActivity);
        $("#saveActivityBtn").addEventListener("click", saveEditedActivity);
        $("#cancelEditBtn").addEventListener("click", cancelEditingActivity);
        $("#deleteActivityBtn").addEventListener(
          "click",
          deleteCurrentActivity
        );

        $("#exportBtn").addEventListener("click", () => {
          const dataStr = JSON.stringify(data, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "italy-trip-activities.json";
          link.click();
          URL.revokeObjectURL(url);
          showNotification("Данные экспортированы", "success");
        });

        // Автосохранение при изменении данных
        const autoSave = debounce(() => saveToStorage(data), 1000);

        // Первоначальная отрисовка
        renderCalendar();
        renderMap();

        showNotification("Планировщик поездки загружен", "success");
      }

      // Запуск при загрузке страницы
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
