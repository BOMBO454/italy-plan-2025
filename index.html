<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      –ú–∞—Ä—à—Ä—É—Ç –ø–æ–µ–∑–¥–∫–∏: –ò—Ç–∞–ª–∏—è ‚Üí –®–≤–µ–π—Ü–∞—Ä–∏—è ‚Ä¢ –§–µ–≤—Ä–∞–ª—å 2026 (OSRM, –±–µ–∑ –∫–ª—é—á–µ–π)
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "custom-bg": "#0f172a",
              "custom-panel": "#111827",
              "custom-panel2": "#0b1220",
              "custom-text": "#e5e7eb",
              "custom-muted": "#9ca3af",
              "custom-accent": "#38bdf8",
              "custom-ok": "#22c55e",
              "custom-warn": "#f59e0b",
            },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --panel2: #0b1220;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #38bdf8;
        --ok: #22c55e;
        --warn: #f59e0b;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial;
      }
      .app {
        display: grid;
        grid-template-columns: 420px 1fr;
        gap: 8px;
        height: 100%;
      }
      .sidebar {
        background: linear-gradient(180deg, var(--panel), var(--panel2));
        padding: 14px;
        overflow: auto;
        border-right: 1px solid #1f2937;
      }
      .map {
        height: 100%;
      }
      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .title {
        font-size: 18px;
        font-weight: 800;
      }
      .subtitle {
        font-size: 12px;
        color: var(--muted);
      }
      .card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 12px;
        margin-bottom: 10px;
      }
      .btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn:hover {
        border-color: var(--accent);
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .kpi {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin: 8px 0 10px;
      }
      .kpi .num {
        font-weight: 800;
        font-size: 18px;
      }
      .list {
        display: grid;
        gap: 6px;
      }
      .line {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 6px 8px;
        border: 1px dashed rgba(255, 255, 255, 0.08);
        border-radius: 10px;
      }
      .edge-label {
        background: rgba(17, 24, 39, 0.85);
        color: #e5e7eb;
        padding: 3px 6px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        font-size: 12px;
        white-space: nowrap;
        width: fit-content !important;
        height: fit-content !important;
      }
      .editor textarea {
        width: 100%;
        min-height: 200px;
        resize: vertical;
        background: #0a0f1a;
        color: #d1d5db;
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 10px;
      }
      a {
        color: #93c5fd;
      }
      @media (max-width: 1000px) {
        .app {
          grid-template-columns: 1fr;
        }
        .sidebar {
          height: 48vh;
        }
        .map {
          height: 52vh;
        }
      }
    </style>
  </head>
  <body class="bg-custom-bg text-custom-text font-sans">
    <div class="min-h-screen grid lg:grid-cols-[420px_1fr] gap-2">
      <aside
        class="bg-gradient-to-b from-custom-panel to-custom-panel2 p-4 overflow-auto border-r border-gray-700 lg:max-h-screen"
      >
        <div
          class="flex items-center justify-between mb-4 p-4 bg-black/20 rounded-xl border border-white/10"
        >
          <div class="flex-1">
            <div class="text-xl font-bold flex items-center gap-2">
              <i class="fas fa-route text-custom-accent"></i>
              –ò—Ç–∞–ª–∏—è ‚Üí –®–≤–µ–π—Ü–∞—Ä–∏—è ‚Ä¢ –ú–∞—Ä—Ç 2026
            </div>
            <div class="text-sm text-custom-muted mt-1">
              –ö–∞—Ä—Ç–∞ –Ω–∞ Leaflet + –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ OSRM (–±–µ–∑ API-–∫–ª—é—á–µ–π).
              –ú–∞—Ä–∫–µ—Ä—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—é—Ç—Å—è, –º–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —Å debounce.
            </div>
          </div>
          <button
            id="fitBtn"
            class="ml-4 px-4 py-2 bg-transparent border border-white/20 text-custom-text rounded-lg hover:border-custom-accent transition-colors"
          >
            <i class="fas fa-expand-arrows-alt mr-2"></i>Fit
          </button>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
          <div class="bg-white/5 border border-white/10 rounded-xl p-4">
            <div class="text-sm text-custom-muted mb-2 flex items-center gap-2">
              <i class="fas fa-cog"></i>
              –ü—Ä–æ—Ñ–∏–ª—å –º–∞—Ä—à—Ä—É—Ç–∞
            </div>
            <select
              id="profile"
              class="w-full p-3 rounded-lg bg-black/40 text-custom-text border border-gray-600 focus:border-custom-accent focus:ring-1 focus:ring-custom-accent font-mono text-sm"
            >
              <option value="driving" selected>üöó driving (–∞–≤—Ç–æ)</option>
              <option value="walking">üö∂ walking (–ø–µ—à–∫–æ–º)</option>
              <option value="cycling">üö¥ cycling (–≤–µ–ª–æ—Å–∏–ø–µ–¥)</option>
            </select>
          </div>
          <div class="bg-white/5 border border-white/10 rounded-xl p-4">
            <div class="text-sm text-custom-muted mb-3 flex items-center gap-2">
              <i class="fas fa-sliders-h"></i>
              –û–ø—Ü–∏–∏
            </div>
            <label class="flex items-center gap-3 cursor-pointer">
              <input
                id="snapToRoads"
                type="checkbox"
                checked
                class="w-4 h-4 text-custom-accent bg-gray-700 border-gray-600 rounded focus:ring-custom-accent"
              />
              <span class="text-sm text-custom-muted"
                >–ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫ –¥–æ—Ä–æ–≥–∞–º</span
              >
            </label>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-4">
          <div
            class="bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-500/20 rounded-xl p-4 text-center"
          >
            <div
              class="text-xs text-blue-300 mb-1 flex items-center justify-center gap-1"
            >
              <i class="fas fa-road"></i>
              –í—Å–µ–≥–æ, –∫–º
            </div>
            <div id="kpiKm" class="text-2xl font-bold text-white">‚Äî</div>
          </div>
          <div
            class="bg-gradient-to-br from-green-500/10 to-green-600/5 border border-green-500/20 rounded-xl p-4 text-center"
          >
            <div
              class="text-xs text-green-300 mb-1 flex items-center justify-center gap-1"
            >
              <i class="fas fa-clock"></i>
              –í—Ä–µ–º—è
            </div>
            <div id="kpiDur" class="text-2xl font-bold text-white">‚Äî</div>
          </div>
          <div
            class="bg-gradient-to-br from-purple-500/10 to-purple-600/5 border border-purple-500/20 rounded-xl p-4 text-center"
          >
            <div
              class="text-xs text-purple-300 mb-1 flex items-center justify-center gap-1"
            >
              <i class="fas fa-map-marker-alt"></i>
              –¢–æ—á–µ–∫
            </div>
            <div id="kpiStops" class="text-2xl font-bold text-white">‚Äî</div>
          </div>
        </div>

        <div class="bg-white/5 border border-white/10 rounded-xl p-4 mb-4">
          <div class="flex items-center gap-2 mb-3">
            <i class="fas fa-route text-custom-accent"></i>
            <div class="text-lg font-semibold">–°–µ–≥–º–µ–Ω—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞</div>
          </div>
          <div id="legs" class="space-y-2"></div>
        </div>

        <div class="bg-white/5 border border-white/10 rounded-xl p-4 mb-4">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <i class="fas fa-code text-custom-accent"></i>
              <div class="text-lg font-semibold">JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</div>
            </div>
            <button
              id="applyBtn"
              class="px-4 py-2 bg-custom-accent text-white rounded-lg hover:bg-custom-accent/80 transition-colors flex items-center gap-2"
            >
              <i class="fas fa-sync-alt"></i>
              –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å
            </button>
          </div>
          <div class="text-sm text-custom-muted mb-3">
            –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ç–æ—á–∫–∏/–ø–æ–ª—è. –ü–æ—Ä—è–¥–æ–∫ —Ç–æ—á–µ–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –º–∞—Ä—à—Ä—É—Ç–∞.
          </div>
          <div class="relative">
            <textarea
              id="jsonEditor"
              spellcheck="false"
              class="w-full min-h-[200px] resize-y bg-black/40 text-gray-300 border border-gray-600 rounded-lg p-3 font-mono text-sm focus:border-custom-accent focus:ring-1 focus:ring-custom-accent"
              placeholder="JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è..."
            ></textarea>
          </div>
        </div>

        <div
          class="text-xs text-custom-muted p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg flex items-start gap-2"
        >
          <i class="fas fa-info-circle text-yellow-400 mt-0.5"></i>
          <div>
            <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –ø—É–±–ª–∏—á–Ω—ã–π OSRM —Å–µ—Ä–≤–µ—Ä –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ø–æ
            –∑–∞–ø—Ä–æ—Å–∞–º; –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ ‚Äî —Å–≤–æ–π –∏–Ω—Å—Ç–∞–Ω—Å/–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞.
          </div>
        </div>
      </aside>

      <main id="map" class="min-h-screen lg:min-h-0"></main>
    </div>

    <!-- ====== –î–ê–ù–ù–´–ï ====== -->
    <script type="application/json" id="trip-data">
      {
        "currency": "RUB",
        "stops": [
          {
            "id": "neapol",
            "city": "–ù–µ–∞–ø–æ–ª—å",
            "country": "–ò—Ç–∞–ª–∏—è",
            "lat": 40.8518,
            "lng": 14.2681,
            "arrive": "2026-02-09",
            "depart": "2026-02-10",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=3079825&checkIn=2026-02-09&checkOut=2026-02-10",
            "costRUB": 18825
          },
          {
            "id": "pompei",
            "city": "–ü–æ–º–ø–µ–∏",
            "country": "–ò—Ç–∞–ª–∏—è",
            "lat": 40.7489,
            "lng": 14.4989,
            "arrive": "2026-02-10",
            "depart": "2026-02-11",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=5123456&checkIn=2026-02-10&checkOut=2026-02-11",
            "costRUB": 15420,
            "note": "–î—Ä–µ–≤–Ω–∏–π –≥–æ—Ä–æ–¥-–º—É–∑–µ–π"
          },
          {
            "id": "rim",
            "city": "–†–∏–º",
            "country": "–ò—Ç–∞–ª–∏—è",
            "lat": 41.9028,
            "lng": 12.4964,
            "arrive": "2026-02-11",
            "depart": "2026-02-13",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2945770&checkIn=2026-02-11&checkOut=2026-02-13",
            "costRUB": 45820
          },
          {
            "id": "florencia",
            "city": "–§–ª–æ—Ä–µ–Ω—Ü–∏—è",
            "country": "–ò—Ç–∞–ª–∏—è",
            "lat": 43.7696,
            "lng": 11.2558,
            "arrive": "2026-02-13",
            "depart": "2026-02-15",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2198765&checkIn=2026-02-13&checkOut=2026-02-15",
            "costRUB": 38950,
            "note": "–ö–æ–ª—ã–±–µ–ª—å –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è"
          },
          {
            "id": "piza",
            "city": "–ü–∏–∑–∞",
            "country": "–ò—Ç–∞–ª–∏—è",
            "lat": 43.7228,
            "lng": 10.4017,
            "arrive": "2026-02-15",
            "depart": "2026-02-15",
            "hotelUrl": "",
            "costRUB": 0,
            "note": "–û–¥–Ω–æ–¥–Ω–µ–≤–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ - –ü–∞–¥–∞—é—â–∞—è –±–∞—à–Ω—è"
          },
          {
            "id": "cinque_terre",
            "city": "–ß–∏–Ω–∫–≤–µ-–¢–µ—Ä—Ä–µ",
            "country": "–ò—Ç–∞–ª–∏—è",
            "lat": 44.1278,
            "lng": 9.7129,
            "arrive": "2026-02-15",
            "depart": "2026-02-16",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=3456789&checkIn=2026-02-15&checkOut=2026-02-16",
            "costRUB": 32150,
            "note": "–ü—è—Ç—å –¥–µ—Ä–µ–≤–µ–Ω—å –Ω–∞ —Å–∫–∞–ª–∞—Ö"
          },
          {
            "id": "bolonya",
            "city": "–ë–æ–ª–æ–Ω—å—è",
            "country": "–ò—Ç–∞–ª–∏—è",
            "lat": 44.4949,
            "lng": 11.3426,
            "arrive": "2026-02-16",
            "depart": "2026-02-17",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2199691&checkIn=2026-02-16&checkOut=2026-02-17",
            "costRUB": 22542
          },
          {
            "id": "veneciya",
            "city": "–í–µ–Ω–µ—Ü–∏—è",
            "country": "–ò—Ç–∞–ª–∏—è",
            "lat": 45.4408,
            "lng": 12.3155,
            "arrive": "2026-02-17",
            "depart": "2026-02-18",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=13660415&checkIn=2026-02-17&checkOut=2026-02-18",
            "costRUB": 16210.26
          },
          {
            "id": "milan",
            "city": "–ú–∏–ª–∞–Ω",
            "country": "–ò—Ç–∞–ª–∏—è",
            "lat": 45.4642,
            "lng": 9.19,
            "arrive": "2026-02-18",
            "depart": "2026-02-20",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2196521&checkIn=2026-02-18&checkOut=2026-02-20",
            "costRUB": 100000
          },
          {
            "id": "vaduc",
            "city": "–í–∞–¥—É—Ü",
            "country": "–õ–∏—Ö—Ç–µ–Ω—à—Ç–µ–π–Ω",
            "lat": 47.141,
            "lng": 9.5209,
            "arrive": "2026-02-20",
            "depart": "2026-02-21",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=104439383&checkIn=2026-02-20&checkOut=2026-02-21",
            "costRUB": 42023,
            "note": "5 —á–∞—Å–æ–≤ –∏–∑ –ú–∏–ª–∞–Ω–∞"
          },
          {
            "id": "cyurix",
            "city": "–¶—é—Ä–∏—Ö",
            "country": "–®–≤–µ–π—Ü–∞—Ä–∏—è",
            "lat": 47.3769,
            "lng": 8.5417,
            "arrive": "2026-02-21",
            "depart": "2026-02-22",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2198062&checkIn=2026-02-21&checkOut=2026-02-22",
            "costRUB": 52453.28
          },
          {
            "id": "bern",
            "city": "–ë–µ—Ä–Ω",
            "country": "–®–≤–µ–π—Ü–∞—Ä–∏—è",
            "lat": 46.947,
            "lng": 7.4474,
            "arrive": "2026-02-22",
            "depart": "2026-02-23",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=749230&checkIn=2026-02-22&checkOut=2026-02-23",
            "costRUB": 52598.94
          },
          {
            "id": "zermatt",
            "city": "–¶–µ—Ä–º–∞—Ç—Ç",
            "country": "–®–≤–µ–π—Ü–∞—Ä–∏—è",
            "lat": 46.0207,
            "lng": 7.7491,
            "arrive": "2026-02-23",
            "depart": "2026-03-01",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2151049&checkIn=2026-02-23&checkOut=2026-03-01",
            "costRUB": 435119,
            "note": "–ù–æ–º–µ—Ä–∞ 6–Ω x 2—á - –≥–æ—Ä–Ω–æ–ª—ã–∂–Ω—ã–π –∫—É—Ä–æ—Ä—Ç"
          },
          {
            "id": "cyurix2",
            "city": "–¶—é—Ä–∏—Ö",
            "country": "–®–≤–µ–π—Ü–∞—Ä–∏—è",
            "lat": 47.3769,
            "lng": 8.5417,
            "arrive": "2026-03-01",
            "depart": "2026-03-02",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2198062&checkIn=2026-03-01&CheckOut=2026-03-02",
            "costRUB": 42975.92,
            "note": "–ü–æ–µ–∑–¥ 10:15‚Äì14:03"
          }
        ]
      }
    </script>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      crossorigin=""
    ></script>
    <script>
      // ===== –£—Ç–∏–ª–∏—Ç—ã =====
      const $ = (sel) => document.querySelector(sel);
      const fmtMoney = (n, c = "RUB") =>
        new Intl.NumberFormat("ru-RU", {
          style: "currency",
          currency: c,
        }).format(n);
      const fmtDur = (sec) => {
        if (!isFinite(sec)) return "‚Äî";
        const totalMinutes = sec / 60;
        const h = Math.floor(totalMinutes / 60);
        const mm = totalMinutes % 60;
        const mmFormatted = mm < 10 ? mm.toFixed(1) : Math.round(mm);
        return (h ? `${h} —á ` : "") + `${mmFormatted} –º`;
      };
      const fmtKm = (m) => (m / 1000).toFixed(1);
      const debounce = (fn, ms = 800) => {
        let t;
        return (...a) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...a), ms);
        };
      };

      // ===== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ =====
      let map,
        routeLine = null,
        stopMarkers = [],
        edgeLabels = [];
      let data = JSON.parse(
        document.getElementById("trip-data").textContent.trim()
      );

      function clearMap() {
        if (routeLine) {
          map.removeLayer(routeLine);
          routeLine = null;
        }
        edgeLabels.forEach((l) => map.removeLayer(l));
        edgeLabels = [];
        stopMarkers.forEach((m) => map.removeLayer(m));
        stopMarkers = [];
      }

      function fitToContent() {
        const group = L.featureGroup([
          ...(routeLine ? [routeLine] : []),
          ...stopMarkers,
        ]);
        if (group.getLayers().length) {
          map.fitBounds(group.getBounds(), { padding: [40, 40] });
        }
      }

      async function buildRoute() {
        if (!data.stops || data.stops.length < 2) return;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const kpiElements = ["kpiKm", "kpiDur", "kpiStops"];
        kpiElements.forEach((id) => {
          document.getElementById(id).innerHTML =
            '<i class="fas fa-spinner fa-spin"></i>';
        });

        try {
          // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: OSRM –∂–¥—ë—Ç lng,lat
          const coords = data.stops.map((s) => `${s.lng},${s.lat}`).join(";");
          const profile = document.getElementById("profile").value || "driving";
          const url = `https://router.project-osrm.org/route/v1/${profile}/${coords}?overview=full&geometries=geojson&steps=false&annotations=false`;

          // –∑–∞–ø—Ä–æ—Å
          const res = await fetch(url);
          if (!res.ok) {
            console.error("OSRM error", res.status);
            showNotification("–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞", "error");
            return;
          }
          const json = await res.json();
          if (!json.routes || !json.routes[0]) {
            console.warn("–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
            showNotification("–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω", "warning");
            return;
          }
          const route = json.routes[0];

          // –ü–æ–ª–∏–ª–∏–Ω–∏—è
          const latlngs = route.geometry.coordinates.map(([lng, lat]) => [
            lat,
            lng,
          ]);
          if (routeLine) map.removeLayer(routeLine);
          routeLine = L.polyline(latlngs, {
            color: "#38bdf8",
            weight: 4,
            opacity: 0.9,
          }).addTo(map);

          // KPI
          document.getElementById("kpiKm").textContent = fmtKm(route.distance);
          document.getElementById("kpiDur").textContent = fmtDur(
            route.duration
          );
          document.getElementById("kpiStops").textContent = data.stops.length;

          // –°–µ–≥–º–µ–Ω—Ç—ã/–ø–æ–¥–ø–∏—Å–∏
          edgeLabels.forEach((l) => map.removeLayer(l));
          edgeLabels = [];
          const legs = route.legs || [];
          const legsCont = document.getElementById("legs");
          legsCont.innerHTML = "";
          for (let i = 0; i < legs.length; i++) {
            const a = data.stops[i];
            const b = data.stops[i + 1];
            const dur = legs[i].duration; // —Å–µ–∫
            const dist = legs[i].distance; // –º
            const mid = [(a.lat + b.lat) / 2, (a.lng + b.lng) / 2];
            const label = L.marker(mid, {
              icon: L.divIcon({
                className: "edge-label",
                html: `${fmtDur(dur)} ¬∑ ${fmtKm(dist)} –∫–º`,
              }),
            }).addTo(map);
            edgeLabels.push(label);
            const row = document.createElement("div");
            row.className =
              "flex items-center justify-between p-3 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 transition-colors";
            row.innerHTML = `
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-custom-accent/20 text-custom-accent rounded-full flex items-center justify-center text-sm font-bold">
                  ${i + 1}
                </div>
                <div>
                  <div class="font-medium">
                    <span class="text-custom-text">${
                      a.city || a.id || "A"
                    }</span>
                    <i class="fas fa-arrow-right mx-2 text-custom-muted"></i>
                    <span class="text-custom-text">${
                      b.city || b.id || "B"
                    }</span>
                  </div>
                  <div class="text-sm text-custom-muted font-mono">${fmtDur(
                    dur
                  )} ‚Ä¢ ${fmtKm(dist)} –∫–º</div>
                </div>
              </div>
              <div class="text-right">
                <i class="fas fa-route text-custom-accent"></i>
              </div>
            `;
            legsCont.appendChild(row);
          }

          fitToContent();
          showNotification("–ú–∞—Ä—à—Ä—É—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω", "success");
        } catch (error) {
          console.error("Route building error:", error);
          showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞", "error");
          return;
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        const colors = {
          success: "bg-green-500/90 border-green-400",
          error: "bg-red-500/90 border-red-400",
          warning: "bg-yellow-500/90 border-yellow-400",
          info: "bg-blue-500/90 border-blue-400",
        };
        const icons = {
          success: "fas fa-check-circle",
          error: "fas fa-exclamation-circle",
          warning: "fas fa-exclamation-triangle",
          info: "fas fa-info-circle",
        };

        notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-3 rounded-lg border shadow-lg z-50 flex items-center gap-2 transform translate-x-full transition-transform`;
        notification.innerHTML = `<i class="${icons[type]}"></i>${message}`;

        document.body.appendChild(notification);

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
        setTimeout(() => {
          notification.classList.remove("translate-x-full");
        }, 100);

        // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          notification.classList.add("translate-x-full");
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      const debouncedBuild = debounce(buildRoute, 900);

      function render() {
        clearMap();
        // –ú–∞—Ä–∫–µ—Ä—ã
        data.stops.forEach((s, idx) => {
          const m = L.marker([s.lat, s.lng], {
            draggable: true,
            title: s.city || s.id || `–¢–æ—á–∫–∞ ${idx + 1}`,
          }).addTo(map);
          m.on("dragend", () => {
            const p = m.getLatLng();
            s.lat = p.lat;
            s.lng = p.lng;
            // –æ–±–Ω–æ–≤–ª—è–µ–º JSON —Ä–µ–¥–∞–∫—Ç–æ—Ä
            document.getElementById("jsonEditor").value = JSON.stringify(
              data,
              null,
              2
            );
            debouncedBuild();
          });
          m.bindPopup(`
            <div class="p-2 min-w-[250px]">
              <div class="flex items-center gap-2 mb-3">
                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                  ${idx + 1}
                </div>
                <div>
                  <div class="font-bold text-lg">${s.city || s.id}</div>
                  <div class="text-sm text-gray-600">${s.country || ""}</div>
                </div>
              </div>
              ${
                s.note
                  ? `<div class="mb-2 p-2 bg-blue-50 rounded text-sm text-blue-800"><i class="fas fa-info-circle mr-1"></i>${s.note}</div>`
                  : ""
              }
              <div class="space-y-2">
                ${
                  s.arrive
                    ? `<div class="flex items-center gap-2"><i class="fas fa-calendar-check text-green-600"></i><span>–ó–∞–µ–∑–¥: <strong>${s.arrive}</strong></span></div>`
                    : ""
                }
                ${
                  s.depart
                    ? `<div class="flex items-center gap-2"><i class="fas fa-calendar-times text-red-600"></i><span>–í—ã–µ–∑–¥: <strong>${s.depart}</strong></span></div>`
                    : ""
                }
                ${
                  s.costRUB
                    ? `<div class="flex items-center gap-2"><i class="fas fa-ruble-sign text-yellow-600"></i><span>–ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ: <strong>${fmtMoney(
                        s.costRUB
                      )}</strong></span></div>`
                    : ""
                }
              </div>
              ${
                s.hotelUrl
                  ? `<div class="mt-3"><a href='${s.hotelUrl}' target='_blank' rel='noopener' class="inline-flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"><i class="fas fa-external-link-alt"></i>–°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç–µ–ª—å</a></div>`
                  : ""
              }
            </div>
          `);
          stopMarkers.push(m);
        });

        debouncedBuild();
        // —Ä–µ–¥–∞–∫—Ç–æ—Ä JSON
        document.getElementById("jsonEditor").value = JSON.stringify(
          data,
          null,
          2
        );
      }

      (function init() {
        map = L.map("map", { zoomControl: true, preferCanvas: true }).setView(
          [44.5, 10.5],
          6
        );
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap",
        }).addTo(map);

        // UI
        document.getElementById("applyBtn").addEventListener("click", () => {
          try {
            data = JSON.parse(document.getElementById("jsonEditor").value);
            render();
          } catch (e) {
            alert("–û—à–∏–±–∫–∞ JSON: " + e.message);
          }
        });
        document
          .getElementById("profile")
          .addEventListener("change", debouncedBuild);
        document
          .getElementById("fitBtn")
          .addEventListener("click", fitToContent);

        render();
      })();
    </script>
  </body>
</html>
