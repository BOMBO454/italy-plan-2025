<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>—É–±–µ—Ä –º–µ–≥–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –∏—Ç–∞–ª–∏–∏ —Å –∫–∞—Ä—Ç–æ–π</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "custom-bg": "#0f172a",
              "custom-panel": "#111827",
              "custom-panel2": "#0b1220",
              "custom-text": "#e5e7eb",
              "custom-muted": "#9ca3af",
              "custom-accent": "#38bdf8",
              "custom-ok": "#22c55e",
              "custom-warn": "#f59e0b",
              hotel: "#10b981",
              transport: "#3b82f6",
              sightseeing: "#f59e0b",
              other: "#8b5cf6",
            },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --panel2: #0b1220;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #38bdf8;
        --ok: #22c55e;
        --warn: #f59e0b;
        --hotel: #10b981;
        --transport: #3b82f6;
        --sightseeing: #f59e0b;
        --other: #8b5cf6;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial;
      }
      .app {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 8px;
        height: 100vh;
      }
      .calendar-panel {
        background: linear-gradient(180deg, var(--panel), var(--panel2));
        padding: 16px 16px 16px 16px; /* –î–æ–±–∞–≤–ª–µ–Ω –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –ø–æ–¥ –ø–ª–∞–≤–∞—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        overflow-y: auto;
        border-right: 1px solid #1f2937;
        position: relative;
      }
      .map-panel {
        height: 100vh;
        border: 1px solid #1f2937;
        border-radius: 12px;
        overflow: hidden;
        margin: 8px;
      }
      .calendar-header {
        position: absolute;
        top: 16px;
        left: 16px;
        right: 16px;
        z-index: 100;
        background: rgba(17, 24, 39, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        margin-bottom: 0;
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: 60px repeat(7, 1fr);
        gap: 1px;
        margin-bottom: 16px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        overflow: hidden;
      }
      .time-column {
        background: rgba(255, 255, 255, 0.03);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
      }
      .time-slot {
        height: 30px;
        padding: 2px;
        font-size: 9px;
        color: var(--muted);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: flex-start;
        justify-content: center;
      }
      .time-slot.hour-marker {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-weight: 600;
      }
      .calendar-day-header {
        background: rgba(255, 255, 255, 0.05);
        /* padding: 12px 4px; */
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        color: var(--muted);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .calendar-day-column {
        display: flex;
        flex-direction: column;
        position: relative;
      }
      .calendar-day-slot {
        height: 30px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        position: relative;
        background: rgba(255, 255, 255, 0.02);
      }
      .calendar-day-slot:hover {
        background: rgba(255, 255, 255, 0.04);
      }
      .calendar-day-slot.today {
        background: rgba(56, 189, 248, 0.05);
      }
      .activity-block {
        position: absolute;
        left: 2px;
        right: 2px;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
        line-height: 1.2;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 2;
        color: white;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .activity-block:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        z-index: 3;
      }
      .activity-item {
        margin-bottom: 2px;
        padding: 2px 4px;
        border-radius: 4px;
        font-size: 10px;
        line-height: 1.2;
        cursor: pointer;
        transition: all 0.2s;
      }
      .activity-item:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      .activity-hotel {
        background: var(--hotel);
        color: white;
      }
      .activity-transport {
        background: var(--transport);
        color: white;
      }
      .activity-sightseeing {
        background: var(--sightseeing);
        color: white;
      }
      .activity-other {
        background: var(--other);
        color: white;
      }
      .activity-legend {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 16px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 8px;
        font-size: 12px;
      }
      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
      }
      .btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text);
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }
      .btn:hover {
        border-color: var(--accent);
        background: rgba(56, 189, 248, 0.1);
      }
      .btn-primary {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
      }
      .btn-primary:hover {
        background: rgba(56, 189, 248, 0.8);
      }
      .btn-danger {
        background: #dc2626;
        border-color: #dc2626;
        color: white;
      }

      /* –ü–ª–∞–≤–∞—é—â–∏–π –±–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ */
      .floating-controls {
        position: absolute;
        top: 16px;
        right: 16px;
        z-index: 1000;
        background: rgba(17, 24, 39, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 8px;
        display: flex;
        gap: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .floating-controls .btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: auto;
        white-space: nowrap;
      }

      .floating-controls .btn i {
        margin-right: 4px;
      }
      .btn-danger:hover {
        background: rgba(220, 38, 38, 0.8);
      }

      .form-group {
        margin-bottom: 16px;
      }
      .form-label {
        display: block;
        margin-bottom: 4px;
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
      }
      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: var(--text);
        font-size: 14px;
      }
      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
      }
      .form-textarea {
        min-height: 80px;
        resize: vertical;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      a {
        color: #93c5fd;
      }
      @media (max-width: 1000px) {
        .app {
          grid-template-columns: 1fr;
          grid-template-rows: 1fr 350px;
        }
        .map-panel {
          height: 350px;
          margin: 4px;
        }
        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="bg-custom-bg text-custom-text font-sans">
    <div class="app">
      <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
      <div class="calendar-panel">
        <div class="text-lg font-bold flex items-center gap-2 mb-1">
          <i class="fas fa-calendar-alt text-custom-accent"></i>
          –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–µ–∑–¥–∫–∏: –ò—Ç–∞–ª–∏—è ‚Üí –®–≤–µ–π—Ü–∞—Ä–∏—è
        </div>
        <div class="activity-legend">
          <div class="legend-item">
            <div class="legend-color" style="background: var(--hotel)"></div>
            <span>–û—Ç–µ–ª—å</span>
          </div>
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: var(--transport)"
            ></div>
            <span>–î–æ—Ä–æ–≥–∞</span>
          </div>
          <div class="legend-item">
            <div
              class="legend-color"
              style="background: var(--sightseeing)"
            ></div>
            <span>–î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--other)"></div>
            <span>–î—Ä—É–≥–æ–µ</span>
          </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º -->
        <div class="flex items-center justify-between mb-4">
          <button id="prevWeek" class="btn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="text-lg font-semibold" id="currentWeek">
            5-11 –º–∞—Ä—Ç–∞ 2026
          </div>
          <button id="nextWeek" class="btn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è —Å–µ—Ç–∫–∞ -->
        <div class="calendar-grid" id="calendarGrid">
          <!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è JS -->
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
        <div id="activityDetails" class="calendar-header" style="display: none">
          <div
            class="text-lg font-semibold mb-3 flex items-center justify-between"
          >
            <div class="flex items-center gap-2">
              <i class="fas fa-info-circle text-custom-accent"></i>
              <span id="detailsTitle">–î–µ—Ç–∞–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</span>
            </div>
            <div class="flex gap-2">
              <button
                id="editActivityBtn"
                class="btn btn-primary"
                style="display: block"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                id="saveActivityBtn"
                class="btn btn-primary"
                style="display: none"
              >
                <i class="fas fa-save"></i>
              </button>
              <button id="cancelEditBtn" class="btn" style="display: none">
                <i class="fas fa-times"></i>
              </button>
              <button
                id="deleteActivityBtn"
                class="btn btn-danger"
                style="display: none"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div id="activityContent"></div>
        </div>
      </div>

      <!-- –ü–ª–∞–≤–∞—é—â–∏–π –±–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
      <div class="floating-controls">
        <button id="addActivityBtn" class="btn btn-primary">
          <i class="fas fa-plus"></i>
          <span class="hidden sm:inline ml-1">–î–æ–±–∞–≤–∏—Ç—å</span>
        </button>
        <button id="exportBtn" class="btn">
          <i class="fas fa-download"></i>
          <span class="hidden sm:inline ml-1">–≠–∫—Å–ø–æ—Ä—Ç</span>
        </button>
        <button id="importBtn" class="btn">
          <i class="fas fa-upload"></i>
          <span class="hidden sm:inline ml-1">–ò–º–ø–æ—Ä—Ç</span>
        </button>
        <button id="fitMapBtn" class="btn">
          <i class="fas fa-expand-arrows-alt"></i>
          <span class="hidden sm:inline ml-1">–ö–∞—Ä—Ç–∞</span>
        </button>
        <input
          type="file"
          id="importFileInput"
          accept=".json"
          style="display: none"
        />
      </div>

      <!-- –ü–∞–Ω–µ–ª—å –∫–∞—Ä—Ç—ã -->
      <div class="map-panel">
        <div id="map" style="width: 100%; height: 100%"></div>
      </div>
    </div>

    <!-- ====== –î–ê–ù–ù–´–ï ====== -->
    <script type="application/json" id="activities-data">
      {
        "currency": "RUB",
        "activities": [
          {
            "id": "neapol",
            "title": "–û—Ç–µ–ª—å –≤ –ù–µ–∞–ø–æ–ª–µ",
            "type": "hotel",
            "startDate": "2026-02-20",
            "startTime": "16:00",
            "endDate": "2026-02-22",
            "endTime": "10:00",
            "location": {
              "name": "–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ",
              "address": "",
              "lat": 40.8517746,
              "lng": 14.2681244
            },
            "url": "https://ru.trip.com/hotels/detail/?hotelId=3079825&checkIn=2026-02-20&checkOut=2026-02-22&adult=6&children=0&subStamp=3001547&crn=2&travelpurpose=0&curr=RUB&hoteluniquekey=&subChannel=&masterhotelid_tracelogid=&NewTaxDescForAmountshowtype0=F&detailFilters=17%7C1~17~1*80%7C2%7C1~80~2&hotelType=normal&display=incavg&barcurr=RUB&locale=ru-RU",
            "cost": 28744.2,
            "note": ""
          },
          {
            "id": "activity_171231321312",
            "title": "–û—Ç–µ–ª—å —Ä–∏–º–∞",
            "type": "hotel",
            "startDate": "2026-02-22",
            "startTime": "19:00",
            "endDate": "2026-02-24",
            "endTime": "7:00",
            "location": {
              "name": "–û—Ç–µ–ª—å",
              "address": "",
              "lat": 40.8517746,
              "lng": 14.2681244
            },
            "url": "https://ru.trip.com/hotels/detail/?hotelId=3079825&checkIn=2026-02-20&checkOut=2026-02-22&adult=6&children=0&subStamp=3001547&crn=2&travelpurpose=0&curr=RUB&hoteluniquekey=&subChannel=&masterhotelid_tracelogid=&NewTaxDescForAmountshowtype0=F&detailFilters=17%7C1~17~1*80%7C2%7C1~80~2&hotelType=normal&display=incavg&barcurr=RUB&locale=ru-RU",
            "cost": 28744.2,
            "note": ""
          }
        ]
      }
    </script>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      crossorigin=""
    ></script>
    <script>
      // ===== –£—Ç–∏–ª–∏—Ç—ã =====
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => document.querySelectorAll(sel);

      const fmtMoney = (n, c = "RUB") =>
        new Intl.NumberFormat("ru-RU", {
          style: "currency",
          currency: c,
        }).format(n);

      const fmtTime = (time) => (time ? time.substring(0, 5) : "");
      const fmtDate = (date) => {
        if (!date) return "";
        const d = new Date(date);
        return d.toLocaleDateString("ru-RU", {
          day: "numeric",
          month: "short",
        });
      };

      const debounce = (fn, ms = 800) => {
        let t;
        return (...a) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...a), ms);
        };
      };

      // ===== LocalStorage —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ =====
      const STORAGE_KEY = "italy-trip-activities";

      function saveToStorage(data) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
          console.error("Error saving to localStorage:", e);
          showNotification("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö", "error");
        }
      }

      function loadFromStorage() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            return JSON.parse(stored);
          }
        } catch (e) {
          console.error("Error loading from localStorage:", e);
        }
        // Fallback to default data
        return JSON.parse(
          document.getElementById("activities-data").textContent.trim()
        );
      }

      // ===== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ =====
      let map,
        activityMarkers = [],
        routeLines = [];
      let currentWeekStart = new Date(2026, 2, 3); // Monday, March 3, 2026
      let selectedActivity = null;
      let editingActivityId = null;
      let data = loadFromStorage();

      // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
      let isSelectingCoordinates = false;
      let coordinateSelectionMode = null; // 'main', 'start', 'end'
      let temporaryMarker = null;

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
      function getEarliestEventDate(activities = null) {
        const activitiesToCheck = activities || data.activities;
        if (!activitiesToCheck || activitiesToCheck.length === 0) {
          return new Date(2026, 1, 19); // –§–µ–≤—Ä–∞–ª—å 19, 2026 (–¥–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        }

        const dates = activitiesToCheck
          .map((activity) => new Date(activity.startDate))
          .filter((date) => !isNaN(date.getTime()))
          .sort((a, b) => a - b);

        return dates.length > 0 ? dates[0] : new Date(2026, 1, 19);
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É
      function setCalendarToDate(targetDate) {
        const monday = new Date(targetDate);
        const dayOfWeek = monday.getDay();
        const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ = 0, –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        monday.setDate(monday.getDate() - daysToSubtract);
        return monday;
      }

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –Ω–µ–¥–µ–ª—é –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
      const savedWeekStart = localStorage.getItem("currentWeekStart");
      if (savedWeekStart) {
        currentWeekStart = new Date(savedWeekStart);
      } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –¥–∞—Ç—ã, –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –Ω–µ–¥–µ–ª–µ —Å –ø–µ—Ä–≤—ã–º —Å–æ–±—ã—Ç–∏–µ–º
        const earliestEventDate = getEarliestEventDate();
        currentWeekStart = setCalendarToDate(earliestEventDate);
      }

      // ===== –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π =====
      const activityIcons = {
        hotel: { icon: "fas fa-bed", color: "var(--hotel)" },
        transport: { icon: "fas fa-route", color: "var(--transport)" },
        sightseeing: { icon: "fas fa-camera", color: "var(--sightseeing)" },
        other: { icon: "fas fa-star", color: "var(--other)" },
      };

      // ===== –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ä—Ç–æ–π =====
      function clearMap() {
        activityMarkers.forEach((m) => map.removeLayer(m));
        activityMarkers = [];
        routeLines.forEach((r) => map.removeLayer(r));
        routeLines = [];
      }

      function fitToActivities() {
        if (activityMarkers.length === 0) return;
        const group = L.featureGroup(activityMarkers);
        map.fitBounds(group.getBounds(), { padding: [20, 20] });
      }

      function createActivityMarker(activity) {
        const iconInfo = activityIcons[activity.type] || activityIcons.other;
        let lat, lng;

        if (activity.location.lat && activity.location.lng) {
          lat = activity.location.lat;
          lng = activity.location.lng;
        } else if (activity.location.startLat && activity.location.startLng) {
          lat = activity.location.startLat;
          lng = activity.location.startLng;
        } else {
          return null;
        }

        const marker = L.marker([lat, lng], {
          icon: L.divIcon({
            className: "activity-marker",
            html: `<div style="background: ${iconInfo.color}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"><i class="${iconInfo.icon}" style="font-size: 12px;"></i></div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15],
          }),
        }).addTo(map);

        marker.bindPopup(createActivityPopup(activity));
        marker.on("click", () => selectActivity(activity));

        return marker;
      }

      function createActivityPopup(activity) {
        return `
          <div class="p-3 min-w-[280px]">
            <div class="flex items-center gap-2 mb-3">
              <div style="background: ${
                activityIcons[activity.type].color
              }; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                <i class="${
                  activityIcons[activity.type].icon
                }" style="font-size: 14px;"></i>
              </div>
              <div>
                <div class="font-bold text-base">${activity.title}</div>
                <div class="text-sm text-gray-600">${
                  activity.location.name
                }</div>
              </div>
            </div>
            
            <div class="space-y-2 mb-3">
              <div class="flex items-center gap-2">
                <i class="fas fa-calendar text-blue-600"></i>
                <span class="text-sm">
                  ${fmtDate(activity.startDate)}${
          activity.startDate !== activity.endDate
            ? " - " + fmtDate(activity.endDate)
            : ""
        }
                  ${
                    activity.startTime ? ", " + fmtTime(activity.startTime) : ""
                  }${
          activity.endTime && activity.startTime !== activity.endTime
            ? " - " + fmtTime(activity.endTime)
            : ""
        }
                </span>
              </div>
              
              ${
                activity.cost
                  ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-ruble-sign text-yellow-600"></i>
                  <span class="text-sm">${fmtMoney(activity.cost)}</span>
                </div>
              `
                  : ""
              }
              
              ${
                activity.location.address
                  ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-map-marker-alt text-red-600"></i>
                  <span class="text-sm">${activity.location.address}</span>
                </div>
              `
                  : ""
              }
            </div>
            
            ${
              activity.note
                ? `
              <div class="mb-3 p-2 bg-blue-50 rounded text-sm text-blue-800">
                <i class="fas fa-info-circle mr-1"></i>${activity.note}
              </div>
            `
                : ""
            }
            
            ${
              activity.url
                ? `
              <div class="mt-3">
                <a href='${activity.url}' target='_blank' rel='noopener' class="inline-flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                  <i class="fas fa-external-link-alt"></i>–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
                </a>
              </div>
            `
                : ""
            }
          </div>
        `;
      }

      function selectActivity(activity) {
        // –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –µ—Å–ª–∏ –±—ã–ª
        if (
          selectedActivity &&
          selectedActivity.type === "transport" &&
          selectedActivity.location.startLat &&
          selectedActivity.location.endLat
        ) {
          unhighlightRoute(selectedActivity);
        }

        selectedActivity = activity;
        showActivityDetails(activity);

        // –í—ã–¥–µ–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
        if (
          activity.type === "transport" &&
          activity.location.startLat &&
          activity.location.endLat
        ) {
          highlightRoute(activity);
        }
      }

      async function buildRouteForActivity(
        transportActivity,
        highlight = false
      ) {
        try {
          const startLng = transportActivity.location.startLng;
          const startLat = transportActivity.location.startLat;
          const endLng = transportActivity.location.endLng;
          const endLat = transportActivity.location.endLat;

          const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;

          const res = await fetch(url);
          if (!res.ok) return;

          const json = await res.json();
          if (!json.routes || !json.routes[0]) return;

          const route = json.routes[0];
          const latlngs = route.geometry.coordinates.map(([lng, lat]) => [
            lat,
            lng,
          ]);

          // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞
          const routeStyles = {
            color: activityIcons.transport.color,
            weight: highlight ? 6 : 3,
            opacity: highlight ? 1.0 : 0.6,
            dashArray: highlight ? null : "5, 5",
          };

          const routeLine = L.polyline(latlngs, routeStyles).addTo(map);

          // –î–æ–±–∞–≤–∏—Ç—å ID –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫ –º–∞—Ä—à—Ä—É—Ç—É –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
          routeLine.activityId = transportActivity.id;
          routeLine.isHighlighted = highlight;

          routeLines.push(routeLine);

          // –ï—Å–ª–∏ —ç—Ç–æ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç, –ø–æ–∫–∞–∑–∞—Ç—å –µ–≥–æ –Ω–∞ –∫–∞—Ä—Ç–µ
          if (highlight) {
            const bounds = L.latLngBounds([
              [startLat, startLng],
              [endLat, endLng],
            ]);
            map.fitBounds(bounds, { padding: [20, 20] });
          }
        } catch (error) {
          console.error("Route building error:", error);
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
      async function highlightRoute(transportActivity) {
        // –ù–∞–π—Ç–∏ –∏ —É–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —ç—Ç–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        const existingRouteIndex = routeLines.findIndex(
          (route) => route.activityId === transportActivity.id
        );

        if (existingRouteIndex !== -1) {
          map.removeLayer(routeLines[existingRouteIndex]);
          routeLines.splice(existingRouteIndex, 1);
        }

        // –°–æ–∑–¥–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
        await buildRouteForActivity(transportActivity, true);
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
      async function unhighlightRoute(transportActivity) {
        // –ù–∞–π—Ç–∏ –∏ —É–¥–∞–ª–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
        const highlightedRouteIndex = routeLines.findIndex(
          (route) =>
            route.activityId === transportActivity.id && route.isHighlighted
        );

        if (highlightedRouteIndex !== -1) {
          map.removeLayer(routeLines[highlightedRouteIndex]);
          routeLines.splice(highlightedRouteIndex, 1);
        }

        // –°–æ–∑–¥–∞—Ç—å –æ–±—ã—á–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
        await buildRouteForActivity(transportActivity, false);
      }

      let isEditingActivity = false;
      let originalActivityData = null;

      function showActivityDetails(activity) {
        const detailsEl = $("#activityDetails");
        const contentEl = $("#activityContent");

        selectedActivity = activity;
        isEditingActivity = false;

        // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
        $("#editActivityBtn").style.display = "block";
        $("#saveActivityBtn").style.display = "none";
        $("#cancelEditBtn").style.display = "none";
        $("#deleteActivityBtn").style.display = "none";
        $("#detailsTitle").textContent = "–î–µ—Ç–∞–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏";

        renderActivityContent(activity, false);
        detailsEl.style.display = "block";
      }

      function renderActivityContent(activity, isEditing = false) {
        const contentEl = $("#activityContent");

        if (isEditing) {
          contentEl.innerHTML = `
            <div class="space-y-4">
              <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="editTitle" class="form-input" value="${
                  activity.title || ""
                }" required>
              </div>
              
              <div class="form-group">
                <label class="form-label">–¢–∏–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</label>
                <select id="editType" class="form-select" required>
                  <option value="hotel" ${
                    activity.type === "hotel" ? "selected" : ""
                  }>üè® –û—Ç–µ–ª—å</option>
                  <option value="transport" ${
                    activity.type === "transport" ? "selected" : ""
                  }>üöó –î–æ—Ä–æ–≥–∞</option>
                  <option value="sightseeing" ${
                    activity.type === "sightseeing" ? "selected" : ""
                  }>üì∏ –î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</option>
                  <option value="other" ${
                    activity.type === "other" ? "selected" : ""
                  }>‚≠ê –î—Ä—É–≥–æ–µ</option>
                </select>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                  <input type="date" id="editStartDate" class="form-input" value="${
                    activity.startDate || ""
                  }" required>
                </div>
                <div class="form-group">
                  <label class="form-label">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
                  <input type="time" id="editStartTime" class="form-input" value="${
                    activity.startTime || ""
                  }">
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                  <input type="date" id="editEndDate" class="form-input" value="${
                    activity.endDate || ""
                  }" required>
                </div>
                <div class="form-group">
                  <label class="form-label">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                  <input type="time" id="editEndTime" class="form-input" value="${
                    activity.endTime || ""
                  }">
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">–ú–µ—Å—Ç–æ</label>
                <input type="text" id="editLocationName" class="form-input" value="${
                  activity.location?.name || ""
                }" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞" required>
              </div>
              
              <div class="form-group">
                <label class="form-label">–ê–¥—Ä–µ—Å</label>
                <input type="text" id="editLocationAddress" class="form-input" value="${
                  activity.location?.address || ""
                }" placeholder="–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å">
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">–®–∏—Ä–æ—Ç–∞</label>
                  <input type="number" step="0.000001" id="editLat" class="form-input" value="${
                    activity.location?.lat || ""
                  }" placeholder="41.9028">
                </div>
                <div class="form-group">
                  <label class="form-label">–î–æ–ª–≥–æ—Ç–∞</label>
                  <input type="number" step="0.000001" id="editLng" class="form-input" value="${
                    activity.location?.lng || ""
                  }" placeholder="12.4964">
                </div>
              </div>
              
              <div class="form-group">
                <button type="button" id="selectCoordinatesBtn" class="btn btn-primary" style="width: 100%;">
                  <i class="fas fa-map-marker-alt mr-1"></i>–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
                </button>
              </div>
              
              <div id="editTransportFields" style="display: ${
                activity.type === "transport" ? "block" : "none"
              };">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">–ù–∞—á–∞–ª—å–Ω–∞—è —à–∏—Ä–æ—Ç–∞</label>
                    <input type="number" step="0.000001" id="editStartLat" class="form-input" value="${
                      activity.location?.startLat || ""
                    }">
                  </div>
                  <div class="form-group">
                    <label class="form-label">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞</label>
                    <input type="number" step="0.000001" id="editStartLng" class="form-input" value="${
                      activity.location?.startLng || ""
                    }">
                  </div>
                </div>
                <div class="form-group">
                  <button type="button" id="selectStartCoordinatesBtn" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-map-marker-alt mr-1"></i>–í—ã–±—Ä–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ
                  </button>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">–ö–æ–Ω–µ—á–Ω–∞—è —à–∏—Ä–æ—Ç–∞</label>
                    <input type="number" step="0.000001" id="editEndLat" class="form-input" value="${
                      activity.location?.endLat || ""
                    }">
                  </div>
                  <div class="form-group">
                    <label class="form-label">–ö–æ–Ω–µ—á–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞</label>
                    <input type="number" step="0.000001" id="editEndLng" class="form-input" value="${
                      activity.location?.endLng || ""
                    }">
                  </div>
                </div>
                <div class="form-group">
                  <button type="button" id="selectEndCoordinatesBtn" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-map-marker-alt mr-1"></i>–í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ
                  </button>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">URL (—Å—Å—ã–ª–∫–∞)</label>
                <input type="url" id="editUrl" class="form-input" value="${
                  activity.url || ""
                }" placeholder="https://example.com">
              </div>
              
              <div class="form-group">
                <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)</label>
                <input type="number" id="editCost" class="form-input" value="${
                  activity.cost || ""
                }" placeholder="0">
              </div>
              
              <div class="form-group">
                <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                <textarea id="editNote" class="form-textarea" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...">${
                  activity.note || ""
                }</textarea>
              </div>
            </div>
          `;

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª–µ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
          $("#editType").addEventListener("change", () => {
            const transportFields = $("#editTransportFields");
            transportFields.style.display =
              $("#editType").value === "transport" ? "block" : "none";
          });
        } else {
          contentEl.innerHTML = `
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <div style="background: ${
                  activityIcons[activity.type]?.color || "var(--other)"
                }; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="${
                    activityIcons[activity.type]?.icon || "fas fa-star"
                  }"></i>
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-white">${
                    activity.title
                  }</h3>
                  <p class="text-sm text-custom-muted">${
                    activity.location?.name || ""
                  }</p>
                  </div>
                </div>
              
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div>
                  <span class="text-custom-muted">–ù–∞—á–∞–ª–æ:</span><br>
                  <span class="text-white">${fmtDate(activity.startDate)}</span>
                  ${
                    activity.startTime
                      ? `<br><span class="text-custom-accent">${fmtTime(
                          activity.startTime
                        )}</span>`
                      : ""
                  }
              </div>
                <div>
                  <span class="text-custom-muted">–ö–æ–Ω–µ—Ü:</span><br>
                  <span class="text-white">${fmtDate(activity.endDate)}</span>
                  ${
                    activity.endTime
                      ? `<br><span class="text-custom-accent">${fmtTime(
                          activity.endTime
                        )}</span>`
                      : ""
                  }
                </div>
              </div>
              
              ${
                activity.location?.address
                  ? `
                <div class="text-sm">
                  <span class="text-custom-muted">–ê–¥—Ä–µ—Å:</span><br>
                  <span class="text-white">${activity.location.address}</span>
                </div>
              `
                  : ""
              }
              
              ${
                activity.cost
                  ? `
                <div class="text-sm">
                  <span class="text-custom-muted">–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                  <span class="text-custom-accent font-semibold ml-2">${fmtMoney(
                    activity.cost
                  )}</span>
                </div>
              `
                  : ""
              }
              
              ${
                activity.note
                  ? `
                <div class="text-sm p-3 bg-white/5 border border-white/10 rounded">
                  <i class="fas fa-sticky-note text-custom-accent mr-2"></i>
                  <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</strong><br>
                  <span class="text-custom-text">${activity.note}</span>
                </div>
              `
                  : ""
              }
              
              ${
                activity.url
                  ? `
                <div class="pt-2">
                  <a href='${activity.url}' target='_blank' rel='noopener' class="btn btn-primary">
                    <i class="fas fa-external-link-alt mr-1"></i>–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
                  </a>
                </div>
              `
                  : ""
              }
              </div>
            `;
        }
      }

      // ===== –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º =====
      function renderCalendar() {
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);

        // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ–¥–µ–ª–∏
        const monthNames = [
          "—è–Ω–≤",
          "—Ñ–µ–≤",
          "–º–∞—Ä",
          "–∞–ø—Ä",
          "–º–∞–π",
          "–∏—é–Ω",
          "–∏—é–ª",
          "–∞–≤–≥",
          "—Å–µ–Ω",
          "–æ–∫—Ç",
          "–Ω–æ—è",
          "–¥–µ–∫",
        ];
        const startStr = `${currentWeekStart.getDate()} ${
          monthNames[currentWeekStart.getMonth()]
        }`;
        const endStr = `${weekEnd.getDate()} ${
          monthNames[weekEnd.getMonth()]
        } ${weekEnd.getFullYear()}`;
        $("#currentWeek").textContent = `${startStr} - ${endStr}`;

        const grid = $("#calendarGrid");
        grid.innerHTML = "";

        // –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã (—Å 0:00 –¥–æ 23:00)
        const timeSlots = [];
        for (let hour = 0; hour < 24; hour++) {
          timeSlots.push(`${String(hour).padStart(2, "0")}:00`);
        }

        // –°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–ª–æ–Ω–∫—É
        const timeColumn = document.createElement("div");
        timeColumn.className = "time-column";

        // –ü—É—Å—Ç–∞—è —è—á–µ–π–∫–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
        const emptyHeader = document.createElement("div");
        emptyHeader.className = "calendar-day-header";
        emptyHeader.style.height = "50px";
        timeColumn.appendChild(emptyHeader);

        // –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã
        timeSlots.forEach((time) => {
          const timeSlot = document.createElement("div");
          timeSlot.className = "time-slot hour-marker";
          timeSlot.textContent = time;
          timeColumn.appendChild(timeSlot);
        });

        grid.appendChild(timeColumn);

        // –°–æ–∑–¥–∞—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
        const dayNames = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"];
        for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
          const currentDay = new Date(currentWeekStart);
          currentDay.setDate(currentDay.getDate() + dayOffset);

          const dayColumn = document.createElement("div");
          dayColumn.className = "calendar-day-column";

          // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è
          const dayHeader = document.createElement("div");
          dayHeader.className = "calendar-day-header";
          dayHeader.innerHTML = `
            <div>${dayNames[dayOffset]}</div>
            <div style="font-size: 16px; font-weight: bold; margin-top: 2px;">${currentDay.getDate()}</div>
          `;
          dayColumn.appendChild(dayHeader);

          const today = new Date();
          const isToday = currentDay.toDateString() === today.toDateString();

          // –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
          timeSlots.forEach((time) => {
            const daySlot = document.createElement("div");
            daySlot.className = "calendar-day-slot";
            if (isToday) daySlot.classList.add("today");

            // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            daySlot.addEventListener("dblclick", () => {
              const dateStr = currentDay.toISOString().split("T")[0];
              createNewActivity(dateStr, time);
            });

            dayColumn.appendChild(daySlot);
          });

          grid.appendChild(dayColumn);
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        renderActivitiesOnCalendar();
      }

      function renderActivitiesOnCalendar() {
        // –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±–ª–æ–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
        $$(".activity-block").forEach((block) => block.remove());

        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –¥–Ω—è–º –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–ª–æ–∂–µ–Ω–∏–π
        const activitiesByDay = {};

        data.activities.forEach((activity) => {
          const activityStart = new Date(
            activity.startDate + "T" + (activity.startTime || "00:00")
          );
          const activityEnd = new Date(
            activity.endDate + "T" + (activity.endTime || "23:59")
          );

          // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
          const weekStart = new Date(currentWeekStart);
          const weekEnd = new Date(currentWeekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          weekEnd.setHours(23, 59, 59);

          if (activityEnd < weekStart || activityStart > weekEnd) return;

          // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
          const startDay = Math.max(
            0,
            Math.floor((activityStart - weekStart) / (1000 * 60 * 60 * 24))
          );
          const endDay = Math.min(
            6,
            Math.floor((activityEnd - weekStart) / (1000 * 60 * 60 * 24))
          );

          for (let dayOffset = startDay; dayOffset <= endDay; dayOffset++) {
            if (!activitiesByDay[dayOffset]) {
              activitiesByDay[dayOffset] = [];
            }

            // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
            const dayStart = new Date(weekStart);
            dayStart.setDate(dayStart.getDate() + dayOffset);
            dayStart.setHours(0, 0, 0); // –ù–∞—á–∞–ª–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤ 0:00

            // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Ä–µ–º—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
            let relativeStart = (activityStart - dayStart) / (1000 * 60 * 60);
            let relativeEnd = (activityEnd - dayStart) / (1000 * 60 * 60);

            // –î–ª—è –º–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –¥–Ω—è
            if (relativeStart < 0) relativeStart = 0; // –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–∞—á–∞–ª–æ—Å—å —Ä–∞–Ω—å—à–µ —ç—Ç–æ–≥–æ –¥–Ω—è
            if (relativeEnd > 24) relativeEnd = 24; // –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –¥–Ω—è
            if (relativeStart >= 24) relativeStart = 24; // –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –¥–Ω—è
            if (relativeEnd <= 0) relativeEnd = 0; // –ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –¥–æ —ç—Ç–æ–≥–æ –¥–Ω—è

            if (relativeEnd <= 0 || relativeStart >= 24) continue;

            activitiesByDay[dayOffset].push({
              activity,
              start: relativeStart,
              end: relativeEnd,
              dayOffset,
            });
          }
        });

        // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å —É—á–µ—Ç–æ–º –Ω–∞–ª–æ–∂–µ–Ω–∏–π
        Object.keys(activitiesByDay).forEach((dayOffset) => {
          const dayActivities = activitiesByDay[dayOffset];
          const grid = $("#calendarGrid");
          const dayColumn = grid.children[parseInt(dayOffset) + 1]; // +1 –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏
          if (!dayColumn) return;

          // –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
          dayActivities.sort((a, b) => a.start - b.start);

          // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —É—Ä–æ–≤–Ω–∏ –Ω–∞–ª–æ–∂–µ–Ω–∏—è
          const levels = [];
          dayActivities.forEach((activityData) => {
            let level = 0;

            // –ù–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
            while (
              levels[level] &&
              levels[level].some(
                (existing) =>
                  !(
                    activityData.end <= existing.start ||
                    activityData.start >= existing.end
                  )
              )
            ) {
              level++;
            }

            if (!levels[level]) levels[level] = [];
            levels[level].push(activityData);
            activityData.level = level;
          });

          // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
          dayActivities.forEach((activityData) => {
            const { activity, start, end, level } = activityData;
            const maxLevels = levels.length;

            const blockTop = Math.max(0, start) * 30 + 50; // 30px –Ω–∞ —á–∞—Å + 50px –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const blockHeight = Math.max(
              15,
              (Math.min(24, end) - Math.max(0, start)) * 30
            );

            // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —à–∏—Ä–∏–Ω—É –∏ –æ—Ç—Å—Ç—É–ø —Å —É—á–µ—Ç–æ–º –Ω–∞–ª–æ–∂–µ–Ω–∏–π
            const baseWidth = 100; // 100% —à–∏—Ä–∏–Ω—ã –º–∏–Ω—É—Å –æ—Ç—Å—Ç—É–ø—ã
            const baseLeftMargin = 10; // –±–∞–∑–æ–≤—ã–π –æ—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –≤ px
            const rightMargin = 10; // –æ—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –≤ px

            let width, leftOffset;
            if (maxLevels === 1) {
              // –ù–µ—Ç –Ω–∞–ª–æ–∂–µ–Ω–∏–π - –ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞
              width = `calc(${baseWidth}% - ${baseLeftMargin + rightMargin}px)`;
              leftOffset = `${baseLeftMargin}px`;
            } else {
              // –ï—Å—Ç—å –Ω–∞–ª–æ–∂–µ–Ω–∏—è - —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é
              const widthPercent = baseWidth / maxLevels;
              const levelOffset = level * widthPercent + baseLeftMargin;
              width = `calc(${widthPercent}% - ${
                baseLeftMargin + rightMargin / maxLevels
              }px)`;
              leftOffset = `calc(${
                level * widthPercent
              }% + ${baseLeftMargin}px)`;
            }

            const activityBlock = document.createElement("div");
            activityBlock.className = `activity-block activity-${activity.type}`;
            activityBlock.style.background =
              activityIcons[activity.type]?.color || "var(--other)";
            activityBlock.style.top = blockTop + "px";
            activityBlock.style.height = blockHeight + "px";
            activityBlock.style.width = width;
            activityBlock.style.left = leftOffset;
            activityBlock.style.zIndex = 10 + level; // –ë–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π z-index –¥–ª—è –≤–µ—Ä—Ö–Ω–∏—Ö —É—Ä–æ–≤–Ω–µ–π
            activityBlock.textContent = activity.title;
            activityBlock.title = `${activity.title}\n${
              activity.location.name
            }\n${fmtTime(activity.startTime)} - ${fmtTime(activity.endTime)}`;

            activityBlock.addEventListener("click", (e) => {
              e.stopPropagation();
              selectActivity(activity);

              // –ù–∞–π—Ç–∏ –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ –∏ –æ—Ç–∫—Ä—ã—Ç—å popup
              const marker = activityMarkers.find(
                (m) => m.activityId === activity.id
              );
              if (marker) {
                marker.openPopup();
                map.setView(marker.getLatLng(), 12);
              }
            });

            // –£–±–∏—Ä–∞–µ–º –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            // activityBlock.addEventListener("dblclick", (e) => {
            //   e.stopPropagation();
            //   openActivityModal(activity);
            // });

            dayColumn.appendChild(activityBlock);
          });
        });
      }

      function renderMap() {
        clearMap();

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
        data.activities.forEach((activity) => {
          const marker = createActivityMarker(activity);
          if (marker) {
            marker.activityId = activity.id;
            activityMarkers.push(marker);
          }
        });

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π —Ç–∏–ø–∞ "transport"
        const transportActivities = data.activities.filter(
          (activity) => activity.type === "transport"
        );
        transportActivities.forEach((activity) => {
          if (
            activity.location.startLat &&
            activity.location.startLng &&
            activity.location.endLat &&
            activity.location.endLng
          ) {
            buildRouteForActivity(activity);
          }
        });

        if (activityMarkers.length > 0) {
          fitToActivities();
        }
      }

      // ===== –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏ =====
      function startEditingActivity() {
        if (!selectedActivity) return;

        isEditingActivity = true;
        originalActivityData = JSON.parse(JSON.stringify(selectedActivity)); // –≥–ª—É–±–æ–∫–∞—è –∫–æ–ø–∏—è

        // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
        $("#editActivityBtn").style.display = "none";
        $("#saveActivityBtn").style.display = "block";
        $("#cancelEditBtn").style.display = "block";
        $("#deleteActivityBtn").style.display = "block";
        $("#detailsTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏";

        renderActivityContent(selectedActivity, true);

        // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        setTimeout(() => {
          const selectBtn = $("#selectCoordinatesBtn");
          const selectStartBtn = $("#selectStartCoordinatesBtn");
          const selectEndBtn = $("#selectEndCoordinatesBtn");

          if (selectBtn) {
            selectBtn.addEventListener("click", () =>
              startCoordinateSelection("main")
            );
          }
          if (selectStartBtn) {
            selectStartBtn.addEventListener("click", () =>
              startCoordinateSelection("start")
            );
          }
          if (selectEndBtn) {
            selectEndBtn.addEventListener("click", () =>
              startCoordinateSelection("end")
            );
          }
        }, 100);
      }

      function cancelEditingActivity() {
        if (!originalActivityData) return;

        isEditingActivity = false;
        selectedActivity = originalActivityData;

        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω
        stopCoordinateSelection();

        // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
        $("#editActivityBtn").style.display = "block";
        $("#saveActivityBtn").style.display = "none";
        $("#cancelEditBtn").style.display = "none";
        $("#deleteActivityBtn").style.display = "none";
        $("#detailsTitle").textContent = "–î–µ—Ç–∞–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏";

        renderActivityContent(selectedActivity, false);
        originalActivityData = null;
      }

      function saveEditedActivity() {
        if (!selectedActivity || !isEditingActivity) return;

        // –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        const formData = {
          title: $("#editTitle").value,
          type: $("#editType").value,
          startDate: $("#editStartDate").value,
          startTime: $("#editStartTime").value,
          endDate: $("#editEndDate").value,
          endTime: $("#editEndTime").value,
          location: {
            name: $("#editLocationName").value,
            address: $("#editLocationAddress").value,
            lat: parseFloat($("#editLat").value) || null,
            lng: parseFloat($("#editLng").value) || null,
          },
          url: $("#editUrl").value,
          cost: parseFloat($("#editCost").value) || 0,
          note: $("#editNote").value,
        };

        // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –¥–ª—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
        if (formData.type === "transport") {
          formData.location.startLat =
            parseFloat($("#editStartLat").value) || null;
          formData.location.startLng =
            parseFloat($("#editStartLng").value) || null;
          formData.location.endLat = parseFloat($("#editEndLat").value) || null;
          formData.location.endLng = parseFloat($("#editEndLng").value) || null;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö
        const index = data.activities.findIndex(
          (a) => a.id === selectedActivity.id
        );
        if (index !== -1) {
          data.activities[index] = { ...data.activities[index], ...formData };
          selectedActivity = data.activities[index];
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        saveToStorage(data);
        renderCalendar();
        renderMap();

        isEditingActivity = false;

        // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
        $("#editActivityBtn").style.display = "block";
        $("#saveActivityBtn").style.display = "none";
        $("#cancelEditBtn").style.display = "none";
        $("#deleteActivityBtn").style.display = "none";
        $("#detailsTitle").textContent = "–î–µ—Ç–∞–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏";

        renderActivityContent(selectedActivity, false);
        originalActivityData = null;

        showNotification("–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞", "success");
      }

      function deleteCurrentActivity() {
        if (!selectedActivity) return;

        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å?")) {
          data.activities = data.activities.filter(
            (a) => a.id !== selectedActivity.id
          );
          saveToStorage(data);
          renderCalendar();
          renderMap();

          $("#activityDetails").style.display = "none";
          selectedActivity = null;
          isEditingActivity = false;
          originalActivityData = null;

          showNotification("–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞", "success");
        }
      }

      // ===== –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) =====
      function createNewActivity(defaultDate = null, defaultTime = null) {
        const newActivity = {
          id: "activity_" + Date.now(),
          title: "–ù–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
          type: "other",
          startDate: defaultDate || "2026-02-22",
          startTime: defaultTime || "12:00",
          endDate: defaultDate || "2026-02-22",
          endTime: "13:00",
          location: {
            name: "–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ",
            address: "",
            lat: null,
            lng: null,
          },
          url: "",
          cost: 0,
          note: "",
        };

        data.activities.push(newActivity);
        saveToStorage(data);
        renderCalendar();
        renderMap();

        // –í—ã–±—Ä–∞—Ç—å –∏ –Ω–∞—á–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        selectedActivity = newActivity;
        showActivityDetails(newActivity);
        startEditingActivity();

        showNotification("–ù–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞", "success");
      }

      // ===== –§—É–Ω–∫—Ü–∏–∏ –≤—ã–±–æ—Ä–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ –∫–∞—Ä—Ç–µ =====
      function startCoordinateSelection(mode = "main") {
        isSelectingCoordinates = true;
        coordinateSelectionMode = mode;
        map.getContainer().style.cursor = "crosshair";

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
        const modeText =
          mode === "start"
            ? "–Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É"
            : mode === "end"
            ? "–∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É"
            : "–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
        showNotification(`–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ "${modeText}"`, "info");
      }

      function stopCoordinateSelection() {
        isSelectingCoordinates = false;
        coordinateSelectionMode = null;
        map.getContainer().style.cursor = "";

        // –£–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
        if (temporaryMarker) {
          map.removeLayer(temporaryMarker);
          temporaryMarker = null;
        }
      }

      function handleMapClick(e) {
        if (!isSelectingCoordinates) return;

        const lat = e.latlng.lat.toFixed(7);
        const lng = e.latlng.lng.toFixed(7);

        // –£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
        if (temporaryMarker) {
          map.removeLayer(temporaryMarker);
        }

        // –°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
        temporaryMarker = L.marker([lat, lng], {
          icon: L.divIcon({
            className: "temp-marker",
            html: '<div style="background: #ff6b6b; border: 2px solid white; border-radius: 50%; width: 16px; height: 16px; margin: -8px;"></div>',
            iconSize: [16, 16],
            iconAnchor: [8, 8],
          }),
        }).addTo(map);

        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
        if (coordinateSelectionMode === "start") {
          $("#editStartLat").value = lat;
          $("#editStartLng").value = lng;
          showNotification("–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–∞", "success");
        } else if (coordinateSelectionMode === "end") {
          $("#editEndLat").value = lat;
          $("#editEndLng").value = lng;
          showNotification("–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–∞", "success");
        } else {
          $("#editLat").value = lat;
          $("#editLng").value = lng;
          showNotification("–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–æ", "success");
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        setTimeout(() => stopCoordinateSelection(), 1000);
      }

      // ===== –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ –∏–º–ø–æ—Ä—Ç–∞ =====
      function exportData() {
        try {
          // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          const exportData = {
            version: "1.0",
            exportDate: new Date().toISOString(),
            appTitle: "–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–µ–∑–¥–∫–∏: –ò—Ç–∞–ª–∏—è ‚Üí –®–≤–µ–π—Ü–∞—Ä–∏—è",
            currency: data.currency,
            currentWeekStart: currentWeekStart.toISOString(),
            activities: data.activities,
            selectedActivityId: selectedActivity ? selectedActivity.id : null,
          };

          const dataStr = JSON.stringify(exportData, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });

          const link = document.createElement("a");
          link.href = URL.createObjectURL(dataBlob);
          link.download = `trip-plan-${
            new Date().toISOString().split("T")[0]
          }.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
          URL.revokeObjectURL(link.href);

          showNotification("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–µ–∑–¥–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!", "success");
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:", error);
          showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö", "error");
        }
      }

      function importData() {
        const fileInput = $("#importFileInput");
        fileInput.click();
      }

      function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importedData = JSON.parse(e.target.result);

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if (
              !importedData.activities ||
              !Array.isArray(importedData.activities)
            ) {
              throw new Error(
                "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–∞—Å—Å–∏–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π"
              );
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–∞
            if (importedData.version && importedData.version !== "1.0") {
              throw new Error(
                `–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è —Ñ–∞–π–ª–∞: ${importedData.version}`
              );
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö
            const requiredFields = [
              "id",
              "title",
              "type",
              "startDate",
              "location",
            ];
            for (const activity of importedData.activities) {
              for (const field of requiredFields) {
                if (!activity[field]) {
                  throw new Error(
                    `–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ ${field}`
                  );
                }
              }
            }

            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞
            const title = importedData.appTitle || "–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–µ–∑–¥–∫–∏";
            const confirmMessage = `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å "${title}"?\n\n–≠—Ç–æ –∑–∞–º–µ–Ω–∏—Ç –í–°–ï —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ:\n‚Ä¢ ${importedData.activities.length} –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π\n‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è\n‚Ä¢ –í—Å—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`;
            if (!confirm(confirmMessage)) {
              return;
            }

            // –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            data.activities = importedData.activities;
            data.currency = importedData.currency || "RUB";

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            if (importedData.currentWeekStart) {
              currentWeekStart = new Date(importedData.currentWeekStart);
            } else {
              // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –Ω–µ–¥–µ–ª–∏, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
              const earliestEventDate = getEarliestEventDate(
                importedData.activities
              );
              currentWeekStart = setCalendarToDate(earliestEventDate);
            }

            // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            selectedActivity = null;
            isEditingActivity = false;
            originalActivityData = null;

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
            saveToStorage();

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            localStorage.setItem(
              "currentWeekStart",
              currentWeekStart.toISOString()
            );

            // –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            clearMap();
            renderCalendar();
            renderActivitiesOnCalendar();
            renderMap();

            // –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –¥–µ—Ç–∞–ª–µ–π
            $("#activityDetails").style.display = "none";

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (importedData.selectedActivityId) {
              const activityToSelect = data.activities.find(
                (a) => a.id === importedData.selectedActivityId
              );
              if (activityToSelect) {
                setTimeout(() => selectActivity(activityToSelect), 100);
              }
            }

            showNotification(
              `–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–µ–∑–¥–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω! –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${importedData.activities.length} –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π`,
              "success"
            );
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:", error);
            showNotification(`–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${error.message}`, "error");
          }
        };

        reader.readAsText(file);
        // –û—á–∏—Å—Ç–∏—Ç—å input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
        event.target.value = "";
      }

      // ===== –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π =====
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        const colors = {
          success: "bg-green-500/90 border-green-400",
          error: "bg-red-500/90 border-red-400",
          warning: "bg-yellow-500/90 border-yellow-400",
          info: "bg-blue-500/90 border-blue-400",
        };
        const icons = {
          success: "fas fa-check-circle",
          error: "fas fa-exclamation-circle",
          warning: "fas fa-exclamation-triangle",
          info: "fas fa-info-circle",
        };

        notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-3 rounded-lg border shadow-lg z-50 flex items-center gap-2 transform translate-x-full transition-transform`;
        notification.innerHTML = `<i class="${icons[type]}"></i>${message}`;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.remove("translate-x-full");
        }, 100);

        setTimeout(() => {
          notification.classList.add("translate-x-full");
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
      function init() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        map = L.map("map", { zoomControl: true, preferCanvas: true }).setView(
          [43.0, 12.0],
          6
        );
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap",
        }).addTo(map);

        // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        map.on("click", handleMapClick);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        $("#prevWeek").addEventListener("click", () => {
          currentWeekStart.setDate(currentWeekStart.getDate() - 1);
          localStorage.setItem(
            "currentWeekStart",
            currentWeekStart.toISOString()
          );
          renderCalendar();
        });

        $("#nextWeek").addEventListener("click", () => {
          currentWeekStart.setDate(currentWeekStart.getDate() + 1);
          localStorage.setItem(
            "currentWeekStart",
            currentWeekStart.toISOString()
          );
          renderCalendar();
        });

        $("#fitMapBtn").addEventListener("click", fitToActivities);
        $("#exportBtn").addEventListener("click", exportData);
        $("#importBtn").addEventListener("click", importData);
        $("#importFileInput").addEventListener("change", handleFileImport);

        // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏
        $("#addActivityBtn").addEventListener("click", () =>
          createNewActivity()
        );
        $("#editActivityBtn").addEventListener("click", startEditingActivity);
        $("#saveActivityBtn").addEventListener("click", saveEditedActivity);
        $("#cancelEditBtn").addEventListener("click", cancelEditingActivity);
        $("#deleteActivityBtn").addEventListener(
          "click",
          deleteCurrentActivity
        );

        $("#exportBtn").addEventListener("click", () => {
          const dataStr = JSON.stringify(data, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "italy-trip-activities.json";
          link.click();
          URL.revokeObjectURL(url);
          showNotification("–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã", "success");
        });

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
        const autoSave = debounce(() => saveToStorage(data), 1000);

        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
        renderCalendar();
        renderMap();

        showNotification("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–µ–∑–¥–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω", "success");
      }

      // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
