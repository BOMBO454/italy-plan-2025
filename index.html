<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Маршрут поездки: Италия → Швейцария • Февраль 2026 (OSRM, без ключей)
    </title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --panel2: #0b1220;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #38bdf8;
        --ok: #22c55e;
        --warn: #f59e0b;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial;
      }
      .app {
        display: grid;
        grid-template-columns: 420px 1fr;
        gap: 8px;
        height: 100%;
      }
      .sidebar {
        background: linear-gradient(180deg, var(--panel), var(--panel2));
        padding: 14px;
        overflow: auto;
        border-right: 1px solid #1f2937;
      }
      .map {
        height: 100%;
      }
      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .title {
        font-size: 18px;
        font-weight: 800;
      }
      .subtitle {
        font-size: 12px;
        color: var(--muted);
      }
      .card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 12px;
        margin-bottom: 10px;
      }
      .btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn:hover {
        border-color: var(--accent);
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .kpi {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin: 8px 0 10px;
      }
      .kpi .num {
        font-weight: 800;
        font-size: 18px;
      }
      .list {
        display: grid;
        gap: 6px;
      }
      .line {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 6px 8px;
        border: 1px dashed rgba(255, 255, 255, 0.08);
        border-radius: 10px;
      }
      .edge-label {
        background: rgba(17, 24, 39, 0.85);
        color: #e5e7eb;
        padding: 3px 6px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        font-size: 12px;
        white-space: nowrap;
        width: 100px !important;
      }
      .editor textarea {
        width: 100%;
        min-height: 200px;
        resize: vertical;
        background: #0a0f1a;
        color: #d1d5db;
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 10px;
      }
      a {
        color: #93c5fd;
      }
      @media (max-width: 1000px) {
        .app {
          grid-template-columns: 1fr;
        }
        .sidebar {
          height: 48vh;
        }
        .map {
          height: 52vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="row" style="margin-bottom: 8px">
          <div>
            <div class="title">Италия → Швейцария • Февраль 2026</div>
            <div class="subtitle">
              Карта на Leaflet + маршрутизация через OSRM (без API-ключей).
              Маркеры перетаскиваются, маршрут перестраивается с debounce.
            </div>
          </div>
          <button id="fitBtn" class="btn">Fit</button>
        </div>

        <div class="grid2">
          <label class="card" style="display: block">
            <div class="subtitle">Профиль маршрута</div>
            <select
              id="profile"
              class="mono"
              style="
                width: 100%;
                padding: 8px;
                border-radius: 8px;
                background: #0a0f1a;
                color: #d1d5db;
                border: 1px solid #1f2937;
              "
            >
              <option value="driving" selected>driving (авто)</option>
              <option value="walking">walking (пешком)</option>
              <option value="cycling">cycling (велосипед)</option>
            </select>
          </label>
          <div class="card">
            <div class="subtitle">Опции</div>
            <label style="display: flex; gap: 8px; align-items: center"
              ><input id="snapToRoads" type="checkbox" checked />
              <span class="subtitle">привязывать к дорогам</span></label
            >
          </div>
        </div>

        <div class="kpi">
          <div class="card">
            <div class="subtitle">Всего, км</div>
            <div id="kpiKm" class="num">—</div>
          </div>
          <div class="card">
            <div class="subtitle">Всего, время</div>
            <div id="kpiDur" class="num">—</div>
          </div>
          <div class="card">
            <div class="subtitle">Узлов</div>
            <div id="kpiStops" class="num">—</div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="margin-bottom: 6px">
            <div class="title" style="font-size: 16px">Сегменты</div>
          </div>
          <div id="legs" class="list"></div>
        </div>

        <div class="card">
          <div class="row" style="margin-bottom: 6px">
            <div class="title" style="font-size: 16px">JSON конфиг</div>
            <button id="applyBtn" class="btn">Перестроить</button>
          </div>
          <div class="subtitle" style="margin-bottom: 6px">
            Редактируйте точки/поля. Порядок точек определяет порядок маршрута.
          </div>
          <div class="editor">
            <textarea id="jsonEditor" spellcheck="false"></textarea>
          </div>
        </div>

        <div class="subtitle">
          Примечание: публичный OSRM сервер ограничен по запросам; для
          продакшена — свой инстанс/альтернатива.
        </div>
      </aside>

      <main id="map" class="map"></main>
    </div>

    <!-- ====== ДАННЫЕ ====== -->
    <script type="application/json" id="trip-data">
      {
        "currency": "RUB",
        "stops": [
          {
            "id": "neapol",
            "city": "Неаполь",
            "country": "Италия",
            "lat": 40.8518,
            "lng": 14.2681,
            "arrive": "2026-02-09",
            "depart": "2026-02-11",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=3079825&checkIn=2026-02-09&checkOut=2026-02-11",
            "costRUB": 28238
          },
          {
            "id": "rim",
            "city": "Рим",
            "country": "Италия",
            "lat": 41.9028,
            "lng": 12.4964,
            "arrive": "2026-02-11",
            "depart": "2026-02-14",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2945770&checkIn=2026-02-11&checkOut=2026-02-14",
            "costRUB": 68729
          },
          {
            "id": "bolonya",
            "city": "Болонья",
            "country": "Италия",
            "lat": 44.4949,
            "lng": 11.3426,
            "arrive": "2026-02-14",
            "depart": "2026-02-15",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2199691&checkIn=2026-02-14&checkOut=2026-02-15",
            "costRUB": 22542
          },
          {
            "id": "veneciya",
            "city": "Венеция",
            "country": "Италия",
            "lat": 45.4408,
            "lng": 12.3155,
            "arrive": "2026-02-15",
            "depart": "2026-02-16",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=13660415&checkIn=2026-02-15&checkOut=2026-02-16",
            "costRUB": 16210.26
          },
          {
            "id": "milan",
            "city": "Милан",
            "country": "Италия",
            "lat": 45.4642,
            "lng": 9.19,
            "arrive": "2026-02-16",
            "depart": "2026-02-18",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2196521&checkIn=2026-02-16&checkOut=2026-02-18",
            "costRUB": 100000
          },
          {
            "id": "vaduc",
            "city": "Вадуц",
            "country": "Лихтенштейн",
            "lat": 47.141,
            "lng": 9.5209,
            "arrive": "2026-02-18",
            "depart": "2026-02-19",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=104439383&checkIn=2026-02-18&checkOut=2026-02-19",
            "costRUB": 42023,
            "note": "5 часов из Милана"
          },
          {
            "id": "cyurix",
            "city": "Цюрих",
            "country": "Швейцария",
            "lat": 47.3769,
            "lng": 8.5417,
            "arrive": "2026-02-19",
            "depart": "2026-02-20",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2198062&checkIn=2026-02-19&checkOut=2026-02-20",
            "costRUB": 52453.28
          },
          {
            "id": "bern",
            "city": "Берн",
            "country": "Швейцария",
            "lat": 46.947,
            "lng": 7.4474,
            "arrive": "2026-02-20",
            "depart": "2026-02-21",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=749230&checkIn=2026-02-20&checkOut=2026-02-21",
            "costRUB": 52598.94
          },
          {
            "id": "zermatt",
            "city": "Церматт",
            "country": "Швейцария",
            "lat": 46.0207,
            "lng": 7.7491,
            "arrive": "2026-02-21",
            "depart": "2026-02-27",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2151049&checkIn=2026-02-21&checkOut=2026-02-27",
            "costRUB": 435119,
            "note": "Номера 4н x 2ч"
          },
          {
            "id": "cyurix2",
            "city": "Цюрих",
            "country": "Швейцария",
            "lat": 47.3769,
            "lng": 8.5417,
            "arrive": "2026-02-27",
            "depart": "2026-02-28",
            "hotelUrl": "https://ru.trip.com/hotels/detail/?hotelId=2198062&checkIn=2026-02-27&CheckOut=2026-02-28",
            "costRUB": 42975.92,
            "note": "Поезд 10:15–14:03"
          }
        ]
      }
    </script>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      crossorigin=""
    ></script>
    <script>
      // ===== Утилиты =====
      const $ = (sel) => document.querySelector(sel);
      const fmtMoney = (n, c = "RUB") =>
        new Intl.NumberFormat("ru-RU", {
          style: "currency",
          currency: c,
        }).format(n);
      const fmtDur = (sec) => {
        if (!isFinite(sec)) return "—";
        const totalMinutes = sec / 60;
        const h = Math.floor(totalMinutes / 60);
        const mm = totalMinutes % 60;
        const mmFormatted = mm < 10 ? mm.toFixed(1) : Math.round(mm);
        return (h ? `${h} ч ` : "") + `${mmFormatted} м`;
      };
      const fmtKm = (m) => (m / 1000).toFixed(1);
      const debounce = (fn, ms = 800) => {
        let t;
        return (...a) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...a), ms);
        };
      };

      // ===== Глобальные =====
      let map,
        routeLine = null,
        stopMarkers = [],
        edgeLabels = [];
      let data = JSON.parse(
        document.getElementById("trip-data").textContent.trim()
      );

      function clearMap() {
        if (routeLine) {
          map.removeLayer(routeLine);
          routeLine = null;
        }
        edgeLabels.forEach((l) => map.removeLayer(l));
        edgeLabels = [];
        stopMarkers.forEach((m) => map.removeLayer(m));
        stopMarkers = [];
      }

      function fitToContent() {
        const group = L.featureGroup([
          ...(routeLine ? [routeLine] : []),
          ...stopMarkers,
        ]);
        if (group.getLayers().length) {
          map.fitBounds(group.getBounds(), { padding: [40, 40] });
        }
      }

      async function buildRoute() {
        if (!data.stops || data.stops.length < 2) return;
        // Координаты: OSRM ждёт lng,lat
        const coords = data.stops.map((s) => `${s.lng},${s.lat}`).join(";");
        const profile = document.getElementById("profile").value || "driving";
        const url = `https://router.project-osrm.org/route/v1/${profile}/${coords}?overview=full&geometries=geojson&steps=false&annotations=false`;
        // запрос
        const res = await fetch(url);
        if (!res.ok) {
          console.error("OSRM error", res.status);
          return;
        }
        const json = await res.json();
        if (!json.routes || !json.routes[0]) {
          console.warn("Маршрут не найден");
          return;
        }
        const route = json.routes[0];

        // Полилиния
        const latlngs = route.geometry.coordinates.map(([lng, lat]) => [
          lat,
          lng,
        ]);
        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(latlngs, {
          color: "#38bdf8",
          weight: 4,
          opacity: 0.9,
        }).addTo(map);

        // KPI
        document.getElementById("kpiKm").textContent = fmtKm(route.distance);
        document.getElementById("kpiDur").textContent = fmtDur(route.duration);
        document.getElementById("kpiStops").textContent = data.stops.length;

        // Сегменты/подписи
        edgeLabels.forEach((l) => map.removeLayer(l));
        edgeLabels = [];
        const legs = route.legs || [];
        const legsCont = document.getElementById("legs");
        legsCont.innerHTML = "";
        for (let i = 0; i < legs.length; i++) {
          const a = data.stops[i];
          const b = data.stops[i + 1];
          const dur = legs[i].duration; // сек
          const dist = legs[i].distance; // м
          const mid = [(a.lat + b.lat) / 2, (a.lng + b.lng) / 2];
          const label = L.marker(mid, {
            icon: L.divIcon({
              className: "edge-label",
              html: `${fmtDur(dur)} · ${fmtKm(dist)} км`,
            }),
          }).addTo(map);
          edgeLabels.push(label);
          const row = document.createElement("div");
          row.className = "line";
          row.innerHTML = `<div>${i + 1}. <b>${
            a.city || a.id || "A"
          }</b> → <b>${
            b.city || b.id || "B"
          }</b></div><div class="mono">${fmtDur(dur)}, ${fmtKm(dist)} км</div>`;
          legsCont.appendChild(row);
        }

        fitToContent();
      }

      const debouncedBuild = debounce(buildRoute, 900);

      function render() {
        clearMap();
        // Маркеры
        data.stops.forEach((s, idx) => {
          const m = L.marker([s.lat, s.lng], {
            draggable: true,
            title: s.city || s.id || `Точка ${idx + 1}`,
          }).addTo(map);
          m.on("dragend", () => {
            const p = m.getLatLng();
            s.lat = p.lat;
            s.lng = p.lng;
            // обновляем JSON редактор
            document.getElementById("jsonEditor").value = JSON.stringify(
              data,
              null,
              2
            );
            debouncedBuild();
          });
          m.bindPopup(`<div><b>${idx + 1}. ${
            s.city || s.id
          }</b><div class="subtitle">${s.country || ""}</div>
          ${s.arrive ? `<div>Заезд: <b>${s.arrive}</b></div>` : ""}
          ${s.depart ? `<div>Выезд: <b>${s.depart}</b></div>` : ""}
          ${
            s.costRUB
              ? `<div>Проживание: <b>${fmtMoney(s.costRUB)}</b></div>`
              : ""
          }
          ${
            s.hotelUrl
              ? `<div style='margin-top:6px'><a href='${s.hotelUrl}' target='_blank' rel='noopener'>Ссылка на отель</a></div>`
              : ""
          }
        </div>`);
          stopMarkers.push(m);
        });

        debouncedBuild();
        // редактор JSON
        document.getElementById("jsonEditor").value = JSON.stringify(
          data,
          null,
          2
        );
      }

      (function init() {
        map = L.map("map", { zoomControl: true, preferCanvas: true }).setView(
          [44.5, 10.5],
          6
        );
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap",
        }).addTo(map);

        // UI
        document.getElementById("applyBtn").addEventListener("click", () => {
          try {
            data = JSON.parse(document.getElementById("jsonEditor").value);
            render();
          } catch (e) {
            alert("Ошибка JSON: " + e.message);
          }
        });
        document
          .getElementById("profile")
          .addEventListener("change", debouncedBuild);
        document
          .getElementById("fitBtn")
          .addEventListener("click", fitToContent);

        render();
      })();
    </script>
  </body>
</html>
